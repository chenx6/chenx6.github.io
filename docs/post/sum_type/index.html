<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>类似 Rust 中的 enum (Sum type) 在 C 语言中的实现 - 二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <div class="post">
    <h2 class="post-title">类似 Rust 中的 enum (Sum type) 在 C 语言中的实现</h2>
    <span class="post-date">2023-12-05</span>
    
  
    
      <a href="https://chenx6.github.io/tags/c/">#c</a>
    
  

    <aside class="toc">
      
      <details>
        <summary>Tabel of contents</summary>
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#在_Rust_中的表示">在 Rust 中的表示</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#Tagged_union">Tagged union</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#Tagged_pointer">Tagged pointer</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#NaN_boxing">NaN boxing</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#几种方法的对比">几种方法的对比</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/sum_type/#Refs">Refs</a>
            
          </li>
          
        </ul>
      </details>
      
    </aside>
    <p>在 C 语言中，没有类似 ML 系语言或者 Rust 那样的 enum 实现。所以本文用于记录 C 中那些用于实现这个特性的相关方法，例如 tagged union, tagged pointer, NaN boxing。</p>
<h2 id="在_Rust_中的表示">在 Rust 中的表示</h2>
<p>例如在之前的博客中，我使用了下面的代码来表示词法分析中分析的 Token。</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">Token</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    Number<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
    Operator<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-storage z-type z-rust">u8</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>在 Rust 语言的底层的实现与下面的 Tagged union 类似。</p>
<h2 id="Tagged_union">Tagged union</h2>
<p>这个应该是最直接的表示方法，通过 <code>tag</code> 成员表示对象类型，并且通过 union 节省数据的占用空间。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-storage z-type z-c">struct</span> <span class="z-meta z-struct z-c"><span class="z-entity z-name z-struct z-c">TaggedUnion</span></span></span><span class="z-meta z-struct z-c"> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">
    <span class="z-support z-type z-stdint z-c">uint32_t</span> tag<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-union z-c"><span class="z-storage z-type z-c">union</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c">
        <span class="z-storage z-type z-c">int</span> number<span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-storage z-type z-c">char</span> operator<span class="z-punctuation z-terminator z-c">;</span>
    </span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h2 id="Tagged_pointer">Tagged pointer</h2>
<p>由于大部分系统分配的内存通常是以 8 字节对齐的，所以指针中存放的值中，即低 3 位(bit)为 0。这种情况下就可以通过低 3 位存储指针相关信息，可以表示 2 ^ 3 = 8 种不同的类型。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-union z-c"><span class="z-storage z-type z-c">union</span> <span class="z-meta z-union z-c"><span class="z-entity z-name z-union z-c">TaggedPointer</span></span></span><span class="z-meta z-union z-c"> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c">
    <span class="z-support z-type z-stdint z-c">uint64_t</span> as_uint64<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-storage z-type z-c">void</span> <span class="z-keyword z-operator z-c">*</span>as_pointer<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<p>然后通过相关的宏来实现从 tagged pointer 中读取和存储数值。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">IS_INT</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">v</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>v<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">as_uint64</span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">GET_AS_INT</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">v</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-support z-type z-stdint z-c">int32_t</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>v<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">as_uint64</span> <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">MAKE_INT</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">i</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-support z-type z-stdint z-c">uint64_t</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>i<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
</span></code></pre>
<h2 id="NaN_boxing">NaN boxing</h2>
<p>在 IEEE 754 标准中，通过将指数位全部置为 1，并且将最少 1 个分数位置为 1 来表示 NaN，这种情况下 NaN 的值中，剩下 51 位为空，可以用来表示其他的值。可以通过指数位以及分数位前 2 位数值，将 NaN 与 double 数值，还有别的类型的数值进行区分开来。由于大部分系统地址空间只有 48 位，所以剩余的空间也足够存储一个内存地址。</p>
<p>在下面的例子中，我们通过自定义的 NaN 值将 double 数值和 NaN boxing 的数值进行区分。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-union z-c"><span class="z-storage z-type z-c">union</span> <span class="z-meta z-union z-c"><span class="z-entity z-name z-union z-c">NaNBoxing</span></span></span><span class="z-meta z-union z-c"> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c">
    <span class="z-support z-type z-stdint z-c">uint64_t</span> as_uint64<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-storage z-type z-c">double</span> as_double<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-union z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

<span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> NaN:
</span><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 0 11111111111 1000000000000000000000000000000000000000000000000000
</span><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">NANISH_MASK</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7ffc000000000000</span></span>
<span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> 0 11111111111 1100000000000000000000000000000000000000000000000000
</span><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">IS_DOUBLE</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">v</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>v<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">as_uint64</span> <span class="z-keyword z-operator z-c">&amp;</span> NANISH<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> NANISH<span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">GET_AS_DOUBLE</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">v</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>v<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">as_double</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
</span></code></pre>
<p>在使用 <code>IS_DOUBLE</code> 时，如果传入的值为 NaN 的话，与 NANISH_MASK 的值不相等。而传入 double 值时，由于 double 值中指数位必有 1 位为 0，所以运算后与 NANISH_MASK 不相等。</p>
<h2 id="几种方法的对比">几种方法的对比</h2>
<p>对比上面的几种表示方法，可以发现 tagged union 表示直接，但是在空间利用率上不如后面 2 种方法，会多出来一个 uint32_t 的内存占用。而 tagged pointer 的类型的转换稍微比 NaN boxing 麻烦一些，需要多做一些位运算。这几种方法都可以在现有的项目中找到使用痕迹。</p>
<h2 id="Refs">Refs</h2>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/645810896">Modern C++真的很烂——std::variant</a></li>
<li><a href="https://research.checkpoint.com/2023/rust-binary-analysis-feature-by-feature/">Rust Binary Analysis, Feature by Feature</a></li>
<li><a href="https://craftinginterpreters.com/optimization.html#nan-boxing">NaN Boxing</a></li>
<li><a href="https://piotrduperas.com/posts/nan-boxing">NaN boxing or how to make the world dynamic</a></li>
<li><a href="https://muxup.com/2023q4/storing-data-in-pointers">Storing data in pointers</a></li>
</ul>

  </div>
  
    <script src="https://utteranc.es/client.js"
          repo="chenx6/chenx6.github.io"
          issue-term="pathname"
          label="comment"
          theme="preferred-color-scheme"
          crossorigin="anonymous"
          async>
    </script>
  
</div>

  
    <footer>2020-∞ chenx6 本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。</footer>
  
</body>

</html>