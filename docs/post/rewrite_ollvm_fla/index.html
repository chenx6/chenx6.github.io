<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>重写 OLLVM 之控制流平坦化 - 二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <div class="post">
    <h2 class="post-title">重写 OLLVM 之控制流平坦化</h2>
    <span class="post-date">2021-01-21</span>
    
  
    
      <a href="https://chenx6.github.io/tags/re/">#re</a>
    
      <a href="https://chenx6.github.io/tags/llvm/">#llvm</a>
    
  

    <aside class="toc">
      
      <details>
        <summary>Table of contents</summary>
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#什么是控制流平坦化">什么是控制流平坦化</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#名词解释">名词解释</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#语言描述控制流平坦化的实现">语言描述控制流平坦化的实现</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#可行的修复方法">可行的修复方法</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#怎么实现">怎么实现</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#总结">总结</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#refs">refs</a>
            
          </li>
          
        </ul>
      </details>
      
    </aside>
    <p>OLLVM 的控制流平坦化是逆向老哥最讨厌的混淆了，因为一旦使用就代表着 IDA 的 decompiler 彻底报废了。所以了解并在<a href="https://github.com/chenx6/baby_obfuscator">自己的项目中</a>重写控制流平坦化挺重要的。</p>
<h2 id="什么是控制流平坦化">什么是控制流平坦化</h2>
<h3 id="名词解释">名词解释</h3>
<h4 id="BasicBlock">BasicBlock</h4>
<p>代码块，以跳转语句结尾的一段代码。</p>
<h3 id="语言描述控制流平坦化的实现">语言描述控制流平坦化的实现</h3>
<p>在 OLLVM 中，Pass 先实现一个永真循环，然后再在这个循环中放入 switch 语句，将代码中除了开始块的所有 BasicBlock 放入这个 switch 语句的不同 case 中，通过修改 switch 的条件，来实现 BasicBlock 之间的跳转。</p>
<h3 id="可行的修复方法">可行的修复方法</h3>
<p>在 <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#refs">利用符号执行去除控制流平坦化</a> 讲解了恢复控制流平坦化的方法，并且在 <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#refs">cq674350529/deflat</a> 使用了 angr 进行实现。</p>
<p>这里引用腾讯 SRC 的思路概括</p>
<blockquote>
<ol>
<li>函数的开始地址为序言的地址</li>
<li>序言的后继为主分发器</li>
<li>后继为主分发器的块为预处理器</li>
<li>后继为预处理器的块为真实块</li>
<li>无后继的块为retn块</li>
<li>剩下的为无用块</li>
</ol>
</blockquote>
<h2 id="怎么实现">怎么实现</h2>
<p>在开始前，先展示一个普通的，带有 <code>if</code> 语句的程序的控制流图。</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">   +--------------------------------------+
</span><span class="z-text z-plain">   | entry:                               |
</span><span class="z-text z-plain">   |  ...                                 |
</span><span class="z-text z-plain">   |  compare instruction                 |
</span><span class="z-text z-plain">   |  br %cmp_res, label %if, label %else |
</span><span class="z-text z-plain">   +-------------------+-----------+------+
</span><span class="z-text z-plain">                       |           |
</span><span class="z-text z-plain">         +-------------+           |
</span><span class="z-text z-plain">         v                         v
</span><span class="z-text z-plain">+--------+-------+        +--------+-------+
</span><span class="z-text z-plain">| if:            |        | else:          |
</span><span class="z-text z-plain">|  br label %end |        |  br label %end |
</span><span class="z-text z-plain">+--------+-------+        +--------+-------+
</span><span class="z-text z-plain">         |                         |
</span><span class="z-text z-plain">         +-----------+-------------+
</span><span class="z-text z-plain">                     v
</span><span class="z-text z-plain">                  +--+---+
</span><span class="z-text z-plain">                  | end: |
</span><span class="z-text z-plain">                  |  ... |
</span><span class="z-text z-plain">                  +------+
</span><span class="z-text z-plain">
</span></code></pre>
<p>首先，先判断函数的 BasicBlock 数量，如果只有一个 BasicBlock，那么就不用进行混淆了。然后将函数中原有的的 BasicBlock 存放到容器中备用，并排除第一个 BasicBlock，因为第一个 BasicBlock 要做特殊处理。</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c">bool</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">runOnFunction</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">Function <span class="z-keyword z-operator z-c">&amp;</span><span class="z-variable z-parameter z-c++">F</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> <span class="z-storage z-modifier z-c++">override</span> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Only one BB in this Function
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>F<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">&lt;=</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Insert All BB into originBB
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  SmallVector<span class="z-keyword z-operator z-comparison z-c">&lt;</span>BasicBlock <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-keyword z-operator z-comparison z-c">&gt;</span> originBB<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>BasicBlock <span class="z-keyword z-operator z-c">&amp;</span>bb <span class="z-keyword z-operator z-ternary z-c">:</span> F<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">emplace_back</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">&amp;</span>bb</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">isa</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>InvokeInst<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">bb<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Remove first BB
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">erase</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>然后，将第一个 BasicBlock 和他结尾的 BranchInst 进行分割，并将第一个 BasicBlock 和后面的 BB 断绝关系。</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> If firstBB&#39;s terminator is BranchInst, then split into two blocks
</span></span><span class="z-source z-c++">BasicBlock <span class="z-keyword z-operator z-c++">*</span>firstBB <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-c">&amp;</span><span class="z-keyword z-operator z-c">*</span>F<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++"><span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>BranchInst <span class="z-keyword z-operator z-c">*</span>br <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">dyn_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>BranchInst<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  BasicBlock<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>iterator iter <span class="z-keyword z-operator z-assignment z-c">=</span> firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">size</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-operator z-arithmetic z-c">--</span>iter<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  BasicBlock <span class="z-keyword z-operator z-c">*</span>tempBB <span class="z-keyword z-operator z-assignment z-c">=</span> firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">splitBasicBlock</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-arithmetic z-c">--</span>iter</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">insert</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> tempBB</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Remove firstBB
</span></span><span class="z-source z-c++">firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">eraseFromParent</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>经过处理后程序控制流图如下。</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">   +--------------------------------------+
</span><span class="z-text z-plain">   | entry:                               |
</span><span class="z-text z-plain">   |  ...                                 |
</span><span class="z-text z-plain">   +--------------------------------------+
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">   +--------------------------------------+
</span><span class="z-text z-plain">   | tempBB:                              |
</span><span class="z-text z-plain">   |  compare instruction                 |
</span><span class="z-text z-plain">   |  br %cmp_res, label %if, label %else |
</span><span class="z-text z-plain">   +-------------------+-----------+------+
</span><span class="z-text z-plain">                       |           |
</span><span class="z-text z-plain">         +-------------+           |
</span><span class="z-text z-plain">         v                         v
</span><span class="z-text z-plain">+--------+-------+        +--------+-------+
</span><span class="z-text z-plain">| if:            |        | else:          |
</span><span class="z-text z-plain">|  br label %end |        |  br label %end |
</span><span class="z-text z-plain">+--------+-------+        +--------+-------+
</span><span class="z-text z-plain">         |                         |
</span><span class="z-text z-plain">         +-----------+-------------+
</span><span class="z-text z-plain">                     v
</span><span class="z-text z-plain">                  +--+---+
</span><span class="z-text z-plain">                  | end: |
</span><span class="z-text z-plain">                  |  ... |
</span><span class="z-text z-plain">                  +------+
</span><span class="z-text z-plain">
</span></code></pre>
<p>接下来就是创建主循环和 switch 语句。先在第一个 BB 处创建 switch 使用的条件变量，然后创建循环的开头 BB，循环结束 BB，switch 的 default 块，最后将他们用 Br 相连起来。</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Create main loop
</span></span><span class="z-source z-c++">BasicBlock <span class="z-keyword z-operator z-c++">*</span>loopEntry <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">BasicBlock<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Create</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">F<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getContext</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Entry<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>F</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">BasicBlock <span class="z-keyword z-operator z-c++">*</span>loopEnd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">BasicBlock<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Create</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">F<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getContext</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>End<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>F</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">BasicBlock <span class="z-keyword z-operator z-c++">*</span>swDefault <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">BasicBlock<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Create</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">F<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getContext</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Default<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-c">&amp;</span>F</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Create switch variable
</span></span><span class="z-source z-c++">IRBuilder<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">entryBuilder</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-variable z-parameter z-c++">firstBB</span><span class="z-punctuation z-separator z-c++">,</span> firstBB<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">AllocaInst <span class="z-keyword z-operator z-c++">*</span>swPtr <span class="z-keyword z-operator z-assignment z-c">=</span> entryBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateAlloca</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">entryBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32Ty</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">StoreInst <span class="z-keyword z-operator z-c++">*</span>storeRng <span class="z-keyword z-operator z-assignment z-c">=</span>
</span><span class="z-source z-c++">    entryBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateStore</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">entryBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">rng</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> swPtr</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">entryBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateBr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">loopEntry</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Create switch statement
</span></span><span class="z-source z-c++">IRBuilder<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">swBuilder</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-variable z-parameter z-c++">loopEntry</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">LoadInst <span class="z-keyword z-operator z-c++">*</span>swVar <span class="z-keyword z-operator z-assignment z-c">=</span> swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateLoad</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">swPtr</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">SwitchInst <span class="z-keyword z-operator z-c++">*</span>swInst <span class="z-keyword z-operator z-assignment z-c">=</span> swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateSwitch</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">swVar<span class="z-punctuation z-separator z-c++">,</span> swDefault<span class="z-punctuation z-separator z-c++">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">BranchInst <span class="z-keyword z-operator z-c++">*</span>dfTerminator <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">BranchInst<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Create</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">loopEntry<span class="z-punctuation z-separator z-c++">,</span> swDefault</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">BranchInst <span class="z-keyword z-operator z-c++">*</span>toLoopEnd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">BranchInst<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">Create</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">loopEntry<span class="z-punctuation z-separator z-c++">,</span> loopEnd</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>经过处理后的程序控制流图如下</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">   +--------------------------------------+            +--------------------------------------+
</span><span class="z-text z-plain">   | entry:                               |            | tempBB:                              |
</span><span class="z-text z-plain">   |  ...                                 |            |  compare instruction                 |
</span><span class="z-text z-plain">   +-------------------+------------------+            |  br %cmp_res, label %if, label %else |
</span><span class="z-text z-plain">                       |                               +-------------------+-----------+------+
</span><span class="z-text z-plain">                       v v---------------------+                           |           |
</span><span class="z-text z-plain">      +----------------+-----------------+     |             +-------------+           |
</span><span class="z-text z-plain">      | Entry:                           |     |             v                         v
</span><span class="z-text z-plain">      |  switch i32 %al, label %Default  |     |    +--------+-------+        +--------+-------+
</span><span class="z-text z-plain">      +----------------+-----------------+     |    | if:            |        | else:          |
</span><span class="z-text z-plain">                       |                       |    |  br label %end |        |  br label %end |
</span><span class="z-text z-plain">       v---------------+                       |    +--------+-------+        +--------+-------+
</span><span class="z-text z-plain">+----------------+                             |             |                         |
</span><span class="z-text z-plain">| Default:       |                             |             +-----------+-------------+
</span><span class="z-text z-plain">|  br label %End |                             |                         v
</span><span class="z-text z-plain">+------+---------+                             |                      +--+---+
</span><span class="z-text z-plain">       |                                       |                      | end: |
</span><span class="z-text z-plain">       +-----------------v                     |                      |  ... |
</span><span class="z-text z-plain">                 +------------------+          |                      +------+
</span><span class="z-text z-plain">                 | End:             |          |
</span><span class="z-text z-plain">                 |  br label %Entry |          |
</span><span class="z-text z-plain">                 +--------+---------+          |
</span><span class="z-text z-plain">                          |                    |
</span><span class="z-text z-plain">                          |                    |
</span><span class="z-text z-plain">                          +--------------------+
</span><span class="z-text z-plain">
</span></code></pre>
<p>然后就是重头戏了：将 BB 们放入 switch 的 case 中。首先先将循环的结尾移动到 BB 后，然后再放入 case 中。然后再判断 BB 的结尾的语句有多少个继承块，如果为 0 个的话，说明是返回语句，那么就不需要管；如果是 1 个的话，说明是无条件跳转语句，那么就计算与其相连的下一个块的 case 值，并更新 switch 的条件变量的值；如果为 2 个的话，说明是一个条件跳转，则根据条件语句 SelectInst 决定下一个块执行的位置;如果是其他情况，则保持该 BB 不变。最后更新下初始的 switch 条件变量的值，保证第一个块的执行。</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Put all BB into switch Instruction
</span></span><span class="z-source z-c++"><span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>BasicBlock <span class="z-keyword z-operator z-c">*</span>bb <span class="z-keyword z-operator z-ternary z-c">:</span> originBB<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">moveBefore</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">loopEnd</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  swInst<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">addCase</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">rng</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> bb</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Recalculate switch Instruction
</span></span><span class="z-source z-c++"><span class="z-keyword z-control z-c++">for</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>BasicBlock <span class="z-keyword z-operator z-c">*</span>bb <span class="z-keyword z-operator z-ternary z-c">:</span> originBB<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">switch</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getNumSuccessors</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">case</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-punctuation z-separator z-c++">:</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> No terminator
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-flow z-break z-c++">break</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">case</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">1</span><span class="z-punctuation z-separator z-c++">:</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Terminator is a non-condition jump
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    Instruction <span class="z-keyword z-operator z-c">*</span>terminator <span class="z-keyword z-operator z-assignment z-c">=</span> bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    BasicBlock <span class="z-keyword z-operator z-c">*</span>sucessor <span class="z-keyword z-operator z-assignment z-c">=</span> terminator<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getSuccessor</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">0</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Find sucessor&#39;s case condition
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    ConstantInt <span class="z-keyword z-operator z-c">*</span>caseNum <span class="z-keyword z-operator z-assignment z-c">=</span> swInst<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">findCaseDest</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">sucessor</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>caseNum <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-language z-c++">nullptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      caseNum <span class="z-keyword z-operator z-assignment z-c">=</span> swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">rng</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Connect this BB to sucessor
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    IRBuilder<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">caseBuilder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">bb<span class="z-punctuation z-separator z-c++">,</span> bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    caseBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateStore</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">caseNum<span class="z-punctuation z-separator z-c++">,</span> swPtr</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    caseBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateBr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">loopEnd</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    terminator<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">eraseFromParent</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span> <span class="z-keyword z-control z-flow z-break z-c++">break</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">case</span> <span class="z-constant z-numeric z-integer z-decimal z-c++">2</span><span class="z-punctuation z-separator z-c++">:</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Terminator is a condition jump
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    Instruction <span class="z-keyword z-operator z-c">*</span>terminator <span class="z-keyword z-operator z-assignment z-c">=</span> bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    ConstantInt <span class="z-keyword z-operator z-c">*</span>trueCaseNum <span class="z-keyword z-operator z-assignment z-c">=</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        swInst<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">findCaseDest</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">terminator<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getSuccessor</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">0</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    ConstantInt <span class="z-keyword z-operator z-c">*</span>falseCaseNum <span class="z-keyword z-operator z-assignment z-c">=</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">        swInst<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">findCaseDest</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">terminator<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getSuccessor</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">1</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>trueCaseNum <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-language z-c++">nullptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      trueCaseNum <span class="z-keyword z-operator z-assignment z-c">=</span> swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">rng</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>falseCaseNum <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-language z-c++">nullptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      falseCaseNum <span class="z-keyword z-operator z-assignment z-c">=</span> swBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getInt32</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">rng</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    IRBuilder<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">caseBuilder</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">bb<span class="z-punctuation z-separator z-c++">,</span> bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">end</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>BranchInst <span class="z-keyword z-operator z-c">*</span>endBr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">dyn_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>BranchInst<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">bb<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getTerminator</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Select the next BB to be executed
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      Value <span class="z-keyword z-operator z-c">*</span>selectInst <span class="z-keyword z-operator z-assignment z-c">=</span> caseBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateSelect</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">          endBr<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">getCondition</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-separator z-c++">,</span> trueCaseNum<span class="z-punctuation z-separator z-c++">,</span> falseCaseNum</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      caseBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateStore</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">selectInst<span class="z-punctuation z-separator z-c++">,</span> swPtr</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      caseBuilder<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">CreateBr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++">loopEnd</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">      terminator<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">eraseFromParent</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">    <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span> <span class="z-keyword z-control z-flow z-break z-c++">break</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-block z-c++">  <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> Set swVar&#39;s origin value, let the first BB executed first
</span></span><span class="z-source z-c++">ConstantInt <span class="z-keyword z-operator z-c++">*</span>caseCond <span class="z-keyword z-operator z-assignment z-c">=</span> swInst<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">findCaseDest</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-c">*</span>originBB<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">begin</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">storeRng<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">setOperand</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-constant z-numeric z-integer z-decimal z-c++">0</span><span class="z-punctuation z-separator z-c++">,</span> caseCond</span></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<blockquote>
<p>图请参考 <a href="https://chenx6.github.io/post/rewrite_ollvm_fla/#refs">Obfuscator-llvm源码分析</a>，用 ASCII 画图有点麻烦...</p>
</blockquote>
<h2 id="总结">总结</h2>
<p>这个控制流平坦化的代码数量也不多，而且程序的逻辑在理清后很容易理解，所以文章的篇幅很短。</p>
<h2 id="refs">refs</h2>
<p><a href="https://github.com/chenx6/baby_obfuscator">chenx6/baby_obfuscator</a></p>
<p><a href="https://sq.163yun.com/blog/article/175307579596922880">Obfuscator-llvm源码分析</a></p>
<p><a href="https://github.com/obfuscator-llvm/obfuscator">obfuscator-llvm/obfuscator</a></p>
<p><a href="https://security.tencent.com/index.php/blog/msg/112">利用符号执行去除控制流平坦化</a></p>
<p><a href="https://github.com/cq674350529/deflat">cq674350529/deflat</a></p>

  </div>
  
    <script src="https://utteranc.es/client.js"
          repo="chenx6/chenx6.github.io"
          issue-term="pathname"
          label="comment"
          theme="preferred-color-scheme"
          crossorigin="anonymous"
          async>
    </script>
  
</div>

  
    <footer>2020-∞ chenx6 本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。</footer>
  
</body>

</html>