<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>QEMU 简易配置（CPU&#x2F;内存&#x2F;网络&#x2F;...） - 二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <div class="post">
    <h2 class="post-title">QEMU 简易配置（CPU&#x2F;内存&#x2F;网络&#x2F;...）</h2>
    <span class="post-date">2023-02-19</span>
    
  
    
      <a href="https://chenx6.github.io/tags/linux/">#linux</a>
    
      <a href="https://chenx6.github.io/tags/qemu/">#qemu</a>
    
  

    <aside class="toc">
      
      <details>
        <summary>Table of contents</summary>
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/qemu/#CPU_配置">CPU 配置</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/qemu/#内存">内存</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/qemu/#网络">网络</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/qemu/#如何创建_tap_设备">如何创建 tap 设备</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/qemu/#使用_dnsmasq_配置_DHCP">使用 dnsmasq 配置 DHCP</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/qemu/#别的选项">别的选项</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/qemu/#最后成果">最后成果</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/qemu/#Refs">Refs</a>
            
          </li>
          
        </ul>
      </details>
      
    </aside>
    <p>从大学开始，我看过了一堆的 QEMU 配置的文章，这些文章要不就是从别的地方复制黏贴出来的，要不就是使用了已经停止维护的工具。所以我决定从网上找一手资料（QEMU Wiki，文档, man qemu，...）来写一篇文章来讲讲怎么简单的配置 QEMU 模拟虚拟机。在文章的最后放了最终运行的命令，大家复制了保存成脚本就可以使用，或者根据自己的要求来配置。（这个脚本已经经过 2 个人使用了，很好用 233）</p>
<h2 id="CPU_配置">CPU 配置</h2>
<p>下面的选项开启 KVM 全虚拟化支持，能提升虚拟机的速度。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">--enable-kvm</span></span>
</span></code></pre>
<p>下面的 CPU 设置选项，是让模拟出来的 CPU 支持主机支持的所有选项。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-cpu</span></span><span class="z-meta z-function-call z-arguments z-shell"> host</span>
</span></code></pre>
<p>下面的选项是指定 SMP（可以简单理解为模拟 CPU 的核数）</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-smp</span></span><span class="z-meta z-function-call z-arguments z-shell"> 4</span>
</span></code></pre>
<h2 id="内存">内存</h2>
<p>下面的选项是指定内存大小。这里我分配了 4G 内存给虚拟机。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-m</span></span><span class="z-meta z-function-call z-arguments z-shell"> 4096M</span>
</span></code></pre>
<h2 id="网络">网络</h2>
<p>QEMU 将网络支持分成了 2 个部分，一部分是给虚拟机（guest）提供的虚拟网络设备（virtual network device），一部分是与模拟 NIC 交互的网络后端（network backend）。QEMU 在默认配置下提供了 SLiRP 后端，在使用这个后端的情况下， ICMP 协议没法工作，也就是没法 ping,但是 TCP 和 UDP 是可以正常工作的。</p>
<p>在网络后端这一层，我们选择 <a href="https://docs.kernel.org/networking/tuntap.html">tap</a>。因为 tap 是在 Linux 内核层面支持的，性能比较好，而且可以支持 ICMP/IP 层协议。需要注意的是 ifname 的参数 &quot;tap6&quot; 是我们创建 tap 设备名字。下面是相关参数。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-netdev</span></span><span class="z-meta z-function-call z-arguments z-shell"> tap,id=net0,ifname=tap6,script=no,downscript=no</span>
</span></code></pre>
<p>QEMU 可以模拟很多的虚拟网络设备，这里我们选择模拟 e1000 网卡。需要注意的是 netdev 的参数需要和前面配置的 netdev 中的 id 对上，这里我们的 netdev 参数为 &quot;net0&quot;。在 mac 参数中，将 MAC 配置成 &quot;52:55:00:d1:55:00&quot;。下面是相关参数。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-device</span></span><span class="z-meta z-function-call z-arguments z-shell"> e1000,netdev=net0,mac=52:55:00:d1:55:00</span>
</span></code></pre>
<h3 id="如何创建_tap_设备">如何创建 tap 设备</h3>
<p>上面的参数需要手动创建 tap 设备才能使用。通过下面的命令既可以创建设备名叫 &quot;tap6&quot; 的设备，并且将 IP 设置在 &quot;192.168.122.1&quot;。下面命令的主要操作就是创建 tap 设备，设置 IP，并且启用设备。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">IP</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">192.168.122.1/24</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> tuntap add tap6 mode tap</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> addr add <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IP</span></span> dev tap6</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link set tap6 up</span>
</span></code></pre>
<p>如果需要让虚拟机和外网相连接的话，还需要下面的命令，来创建网桥，使得虚拟机 tap 设备和宿主机网卡相连。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link add br0 type bridge</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link set dev tap6 master br0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link set dev eth0 master br0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link set dev br0 up</span>
</span></code></pre>
<h3 id="使用_dnsmasq_配置_DHCP">使用 dnsmasq 配置 DHCP</h3>
<p>如果需要让虚拟机走 DHCP 协议获取 IP 的话，最简单的方式就是在宿主机上使用 dnsmasq 来给虚拟机分配 IP。下面是 dnsmasq 的配置，配合上面的 IP 配置，可以让宿主机的 IP 设置为 192.168.122.1，虚拟机的 IP 在 192.168.122.2,192.168.122.200 这个范围内。</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">listen-address=192.168.122.1
</span><span class="z-text z-plain">dhcp-range=192.168.122.2,192.168.122.200
</span></code></pre>
<h3 id="别的选项">别的选项</h3>
<p>下面的选项开启 GDB 远程调试。在 GDB 里使用 <code>target remote :5555</code> 即可连接。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-gdb</span></span><span class="z-meta z-function-call z-arguments z-shell"> tcp::5555</span>
</span></code></pre>
<h2 id="最后成果">最后成果</h2>
<p>network.sh 脚本，需要 root 权限运行，并且需要配置 dnsmasq 启用 DHCP 服务。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/usr/bin/env bash</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-set z-shell">set</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>x</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">IP</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">192.168.122.1/24</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> tuntap add tap6 mode tap</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> addr add <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IP</span></span> dev tap6</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ip</span></span><span class="z-meta z-function-call z-arguments z-shell"> link set tap6 up  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Check again when VM boot finish</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dnsmasq</span></span>
</span></code></pre>
<p>boot.sh 脚本，通过 <code>boot.sh $虚拟机镜像名字</code> 来运行虚拟机。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">!/usr/bin/env bash</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-set z-shell">set</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">-</span>x</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qemu-system-x86_64</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>enable-kvm</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  -</span>m</span> 4096M <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  -</span>cpu</span> host <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  -</span>smp</span> 4 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  -</span>netdev</span> tap,id=net0,ifname=tap6,script=no,downscript=no <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  -</span>device</span> e1000,netdev=net0,mac=52:55:00:d1:55:00 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">1</span></span></span>
</span></code></pre>
<h2 id="Refs">Refs</h2>
<ul>
<li><code>man qemu</code></li>
<li><a href="https://wiki.qemu.org/Documentation/Networking">https://wiki.qemu.org/Documentation/Networking</a></li>
</ul>

  </div>
  
    <script src="https://utteranc.es/client.js"
          repo="chenx6/chenx6.github.io"
          issue-term="pathname"
          label="comment"
          theme="preferred-color-scheme"
          crossorigin="anonymous"
          async>
    </script>
  
</div>

  
    <footer>2020-∞ chenx6 本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。</footer>
  
</body>

</html>