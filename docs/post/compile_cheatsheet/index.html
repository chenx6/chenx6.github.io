<!DOCTYPE html>
<html lang="zh-hans">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.99.1" />


<link rel="icon" href="data:;base64,iVBORw0KGgo=">


<title>关于 C 语言编译的那些破事 - 二进制咸鱼的自我救赎</title>


<meta name="author" content="chen_null" />


<meta name="description" content="C 和 C&#43;&#43; 的编译是真的痛苦，会出现一堆离谱的问题。所以我特地写一篇文章讲一下这些破事，并且提供一些样例代码方便复制黏贴。" />


<meta name="keywords" content="cpp, c, compile" />


<meta property="og:title" content="关于 C 语言编译的那些破事" />
<meta name="twitter:title" content="关于 C 语言编译的那些破事" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chenx6.github.io/post/compile_cheatsheet/" /><meta property="og:description" content="C 和 C&#43;&#43; 的编译是真的痛苦，会出现一堆离谱的问题。所以我特地写一篇文章讲一下这些破事，并且提供一些样例代码方便复制黏贴。" />
<meta name="twitter:description" content="C 和 C&#43;&#43; 的编译是真的痛苦，会出现一堆离谱的问题。所以我特地写一篇文章讲一下这些破事，并且提供一些样例代码方便复制黏贴。" /><meta name="twitter:card" content="summary" /><meta property="article:published_time" content="2022-05-21T00:00:00+00:00" /><meta property="article:modified_time" content="2022-05-21T00:00:00+00:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://chenx6.github.io/assets/css/fuji.min.css" />








</head>

<body
  data-theme="auto"
  data-theme-auto='false'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://chenx6.github.io/">二进制咸鱼的自我救赎</a>
            
            <span class="title-sub">幸福往往是摸的透彻，而敬业的心却往往隐藏。</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://chenx6.github.io/post/compile_cheatsheet/">关于 C 语言编译的那些破事</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-05-21</span>



<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/cpp">cpp</a>&nbsp;<a href="/tags/c">c</a>&nbsp;<a href="/tags/compile">compile</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <p>C 和 C++ 的编译是真的痛苦，会出现一堆离谱的问题。所以我特地写一篇文章讲一下这些破事，并且提供一些样例代码方便复制黏贴。</p>
<h2 id="编译过程简述">编译过程简述</h2>
<p>在网上能找到一堆的编译流程相关的博客，而且肯定比我讲的正确，所以这里我就简单概括下。</p>
<p>现在很少有程序能只依赖与 C 标准库和系统 API 了，所以会有一堆的外部依赖库。要想编译成功，得让编译器和链接器都知道去哪找这些库，怎么链接上。于是就有了一堆的编译管理工具。像 CMake 和 Meson 是负责生成编译的脚本，make 和 ninja 则是负责执行编译任务，然后是 gcc 和 clang 将代码编译成目标文件，最后有 ld, gold, mold 将目标文件进行链接生成可执行文件。</p>
<pre><code class="language-plaintext">CMake -&gt; make  -&gt; gcc   -&gt; ld   -&gt; 可执行文件
Meson    ninja    clang    gold
Bazel    ...      zig cc   lld
...               ...      mold
                           ...
</code></pre>
<h2 id="编译系统">编译系统</h2>
<h3 id="meson">Meson</h3>
<p>样例代码</p>
<pre><code class="language-meson"># 指定项目名称，使用语言，默认选项
project('project name', 'cpp'
        default_options : ['c_std=c11', 'cpp_std=c++11'])
# 指定头文件位置
incdir = include_directories('include')
#（可选）使用 math 库
cc = meson.get_compiler('c')
m_dep = cc.find_library('m')
#（可选）使用 `dependency` 寻找库依赖
zdep = dependency('zlib', version: '&gt;=1.2.8')
#（可选）子目录
subdir('tests')
# 指定代码文件位置，头文件位置来生成可执行文件
utils = ['src/logger.cpp', 'src/utils.cpp']
# 可执行文件的相关设置
executable('client', 'src/main_client.cpp', 'src/client.cpp', utils, 
           include_directories : incdir,
           dependencies : m_dep
           cpp_args: [],
           c_args: [],
           link_args : '')
# 在 executable 函数中添加下面的设置可以编译 32 位，静态链接的程序
#    cpp_args: ['-m32', '-static'],
#    c_args: ['-m32', '-static'],
#    link_args : '-m32'
</code></pre>
<p>常用编译命令</p>
<pre><code class="language-bash"># 生成编译所需文件
meson setup builddir --wipe
# Debug 编译
meson setup --buildtype debug --reconfigure
# 编译
meson compile -C builddir
</code></pre>
<p>更多的内容参考 <a href="#refs">#refs</a></p>
<h3 id="cmake">CMake</h3>
<p>样例代码</p>
<pre><code class="language-cmake"># 指定项目名字，CMake 版本要求，C++ 版本要求
project(project_name)
cmake_minimum_required(VERSION 3.0)
set(CXX_STANDARD 11)

# 使用 CMake 管理的库
find_package(OpenCV REQUIRED)
include_directories(${OpenCV_INCLUDE_DIRS})
link_directories(${OpenCV_LIBRARY_DIRS})

# 使用由 pkg-config 管理的库
find_package(PkgConfig)
pkg_search_module(LIBNOTIFY REQUIRED libnotify)
include_directories(${LIBNOTIFY_INCLUDE_DIRS})

# 指定头文件目录
include_directories(./include)
# 扫描目录，获得目录下源代码位置
aux_source_directory(./src SRC)
add_executable(name ${SRC})
# 链接上库
target_link_libraries(${PROJECT_NAME} ${OpenCV_LIBS} ${LIBNOTIFY_LIBRARIES})
</code></pre>
<p>常用命令</p>
<pre><code class="language-bash"># 编译
cd build &amp;&amp; cmake ..
# Debug 编译
cmake -DCMAKE_BUILD_TYPE=Debug ..
</code></pre>
<h3 id="makefile">Makefile</h3>
<p>Makefile 的可读性真的是灾难级别的，下面这篇文章图文并茂，讲的很好，推荐阅读！！！</p>
<p><a href="https://zhuanlan.zhihu.com/p/47390641" target="_blank">Makefile由浅入深&ndash;教程、干货</a></p>
<h2 id="库管理工具">库管理工具</h2>
<h3 id="pkg-config">pkg-config</h3>
<table>
<thead>
<tr>
<th>选项</th>
<th>作用</th>
<th>样例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--cflags</code></td>
<td>查询这个库的所需要的 CFLAGS</td>
<td><code>pkg-config --cflags glib-2.0</code></td>
</tr>
<tr>
<td><code>--libs</code></td>
<td>查询链接上这个库的所需要的选项</td>
<td><code>pkg-config --libs zlib</code></td>
</tr>
<tr>
<td><code>–-list-all</code></td>
<td>列出所有的，可以被查找到的库</td>
<td><code>pkg-config –-list-all | rg $库</code></td>
</tr>
</tbody>
</table>
<p>设置 pkg-config 搜索路径</p>
<pre><code class="language-bash">export PKG_CONFIG_PATH=/usr/lib/pkgconfig/:$PKG_CONFIG_PATH
</code></pre>
<p>官方文档参考 <a href="#refs">#refs</a></p>
<h2 id="编译器">编译器</h2>
<h3 id="gcc编译选项">GCC编译选项</h3>
<h4 id="链接">链接</h4>
<table>
<thead>
<tr>
<th>选项</th>
<th>作用</th>
<th>样例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-l$library</code></td>
<td>链接上某个库</td>
<td><code>-lm</code></td>
</tr>
<tr>
<td><code>-static</code></td>
<td>静态链接库</td>
<td></td>
</tr>
<tr>
<td><code>-static-libstdc++</code></td>
<td>静态链接libstdc++</td>
<td></td>
</tr>
<tr>
<td><code>-Wl,$option</code></td>
<td>将链接选项传递给 ld</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="目录搜索">目录搜索</h4>
<table>
<thead>
<tr>
<th>选项</th>
<th>作用</th>
<th>样例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-I $dir</code></td>
<td>（大写的i）头文件搜索路径</td>
<td><code>-I ./include</code></td>
</tr>
<tr>
<td><code>-L$dir</code></td>
<td>库文件搜索路径</td>
<td><code>-L./lib</code></td>
</tr>
<tr>
<td><code>--sysroot=$dir</code></td>
<td>头文件和库的搜索路径</td>
<td><code>--sysroot=/usr</code></td>
</tr>
</tbody>
</table>
<h3 id="使用-zig-cc-进行跨平台编译">使用 zig cc 进行跨平台编译</h3>
<p>zig cc 真是跨平台编译救星，下面演示下常见命令。</p>
<pre><code class="language-bash"># 显示支持的 libc
zig targets | jq .libc
# 直接编译
zig cc $文件 -target $目标
zig cc hello.c -target i386-linux-musl -static
# 让 make 等工具使用
make CC=&quot;zig cc&quot; CXX=&quot;zig c++&quot;
</code></pre>
<p>参考文章 <a href="#refs">#refs</a></p>
<h2 id="环境配置">环境配置</h2>
<h3 id="dockerpodman">Docker/Podman</h3>
<p>Ubuntu image，添加 32 位支持，安装编译工具链，库和 CMake</p>
<pre><code class="language-dockerfile">FROM ubuntu:18.04

RUN dpkg --add-architecture i386 &amp;&amp; \
    apt update &amp;&amp; \
    apt install -y gcc-multilib g++-multilib build-essential cmake
</code></pre>
<p>CentOS image，从本地复制一份 ninja，安装编译工具，相关的库和 Meson</p>
<pre><code class="language-dockerfile">FROM amd64/centos:7

COPY ./ninja /usr/local/bin

RUN yum install python3 glibc-devel.i686 glibc-devel.x86_64 libgcc.i686 libgcc.x86_64 libstdc++-devel.i686 libstdc++-devel -y &amp;&amp; \
    yum group install &quot;Development Tools&quot; -y

RUN python3 -m pip install meson -i https://opentuna.cn/pypi/web/simple
</code></pre>
<p>使用容器进行编译。设置成运行完后删除，并将当前目录映射到 &ldquo;/src&rdquo; 目录下，启动名字为 <code>$容器名字</code> 的容器。</p>
<pre><code class="language-bash">podman run --rm -v &quot;$(pwd):/src&quot; -it $容器名字
</code></pre>
<h2 id="refs">Refs</h2>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc-11.3.0/gcc/" target="_blank">https://gcc.gnu.org/onlinedocs/gcc-11.3.0/gcc/</a></li>
<li><a href="https://www.freedesktop.org/wiki/Software/pkg-config" target="_blank">https://www.freedesktop.org/wiki/Software/pkg-config</a></li>
<li><a href="https://mesonbuild.com/howtox.html" target="_blank">https://mesonbuild.com/howtox.html</a></li>
<li><a href="https://mesonbuild.com/Meson-sample.html" target="_blank">https://mesonbuild.com/Meson-sample.html</a></li>
<li><a href="https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html" target="_blank">https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html</a></li>
</ul>

    </div>
</article>



<div class="post-comment" data-comment="utterances">
    <span class="post-comment-notloaded">
        <i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;查看评论
    </span>
    <script>
        function loadComment() {
            var commentArea = document.querySelector('.post-comment');
            var utterancesTheme = document.body.getAttribute('data-theme');
            if (utterancesTheme === 'auto') {
                utterancesTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'photon-dark' :
                    'github-light';
            } else {
                utterancesTheme = utterancesTheme === 'dark' ? 'photon-dark' : 'github-light';
            }
            var s = document.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'chenx6\/chenx6.github.io');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('theme', utterancesTheme);
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('async', '');
            document.querySelector('.post-comment').appendChild(s);
            document.querySelector('span.post-comment-notloaded').setAttribute('style', 'display: none;');
        }
    </script>
</div>


            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/chenx6" target="_blank"><span>GitHub</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/arm/">arm</a>
            </span>
            
            <span>
                <a href="/tags/backdoor/">backdoor</a>
            </span>
            
            <span>
                <a href="/tags/c/">c</a>
            </span>
            
            <span>
                <a href="/tags/codeql/">codeql</a>
            </span>
            
            <span>
                <a href="/tags/compile/">compile</a>
            </span>
            
            <span>
                <a href="/tags/cpp/">cpp</a>
            </span>
            
            <span>
                <a href="/tags/elf/">elf</a>
            </span>
            
            <span>
                <a href="/tags/frida/">frida</a>
            </span>
            
            <span>
                <a href="/tags/fuzz/">fuzz</a>
            </span>
            
            <span>
                <a href="/tags/linux/">linux</a>
            </span>
            
            <span>
                <a href="/tags/llvm/">llvm</a>
            </span>
            
            <span>
                <a href="/tags/mal/">mal</a>
            </span>
            
            <span>
                <a href="/tags/plt/">plt</a>
            </span>
            
            <span>
                <a href="/tags/pwn/">pwn</a>
            </span>
            
            <span>
                <a href="/tags/re/">re</a>
            </span>
            
            <span>
                <a href="/tags/rop/">rop</a>
            </span>
            
            <span>
                <a href="/tags/rust/">rust</a>
            </span>
            
            <span>
                <a href="/tags/server/">server</a>
            </span>
            
            <span>
                <a href="/tags/vm/">vm</a>
            </span>
            
        </div>
    </div>
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#编译过程简述">编译过程简述</a></li>
    <li><a href="#编译系统">编译系统</a>
      <ul>
        <li><a href="#meson">Meson</a></li>
        <li><a href="#cmake">CMake</a></li>
        <li><a href="#makefile">Makefile</a></li>
      </ul>
    </li>
    <li><a href="#库管理工具">库管理工具</a>
      <ul>
        <li><a href="#pkg-config">pkg-config</a></li>
      </ul>
    </li>
    <li><a href="#编译器">编译器</a>
      <ul>
        <li><a href="#gcc编译选项">GCC编译选项</a></li>
        <li><a href="#使用-zig-cc-进行跨平台编译">使用 zig cc 进行跨平台编译</a></li>
      </ul>
    </li>
    <li><a href="#环境配置">环境配置</a>
      <ul>
        <li><a href="#dockerpodman">Docker/Podman</a></li>
      </ul>
    </li>
    <li><a href="#refs">Refs</a></li>
  </ul>
</nav></div>
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/chenx6" target="_blank"><span>GitHub</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/arm/">arm</a>
            </span>
            
            <span>
                <a href="/tags/backdoor/">backdoor</a>
            </span>
            
            <span>
                <a href="/tags/c/">c</a>
            </span>
            
            <span>
                <a href="/tags/codeql/">codeql</a>
            </span>
            
            <span>
                <a href="/tags/compile/">compile</a>
            </span>
            
            <span>
                <a href="/tags/cpp/">cpp</a>
            </span>
            
            <span>
                <a href="/tags/elf/">elf</a>
            </span>
            
            <span>
                <a href="/tags/frida/">frida</a>
            </span>
            
            <span>
                <a href="/tags/fuzz/">fuzz</a>
            </span>
            
            <span>
                <a href="/tags/linux/">linux</a>
            </span>
            
            <span>
                <a href="/tags/llvm/">llvm</a>
            </span>
            
            <span>
                <a href="/tags/mal/">mal</a>
            </span>
            
            <span>
                <a href="/tags/plt/">plt</a>
            </span>
            
            <span>
                <a href="/tags/pwn/">pwn</a>
            </span>
            
            <span>
                <a href="/tags/re/">re</a>
            </span>
            
            <span>
                <a href="/tags/rop/">rop</a>
            </span>
            
            <span>
                <a href="/tags/rust/">rust</a>
            </span>
            
            <span>
                <a href="/tags/server/">server</a>
            </span>
            
            <span>
                <a href="/tags/vm/">vm</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#编译过程简述">编译过程简述</a></li>
    <li><a href="#编译系统">编译系统</a>
      <ul>
        <li><a href="#meson">Meson</a></li>
        <li><a href="#cmake">CMake</a></li>
        <li><a href="#makefile">Makefile</a></li>
      </ul>
    </li>
    <li><a href="#库管理工具">库管理工具</a>
      <ul>
        <li><a href="#pkg-config">pkg-config</a></li>
      </ul>
    </li>
    <li><a href="#编译器">编译器</a>
      <ul>
        <li><a href="#gcc编译选项">GCC编译选项</a></li>
        <li><a href="#使用-zig-cc-进行跨平台编译">使用 zig cc 进行跨平台编译</a></li>
      </ul>
    </li>
    <li><a href="#环境配置">环境配置</a>
      <ul>
        <li><a href="#dockerpodman">Docker/Podman</a></li>
      </ul>
    </li>
    <li><a href="#refs">Refs</a></li>
  </ul>
</nav>
    </div>
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <p>
                除特殊注明部分，本站内容采用 <a rel="license" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a> 进行许可。
            </p>
            
            <span>&copy; 2022
                <a href="https://chenx6.github.io/">chen_null</a>
                
                | 基于 <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 构建
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>



</body>

</html>
