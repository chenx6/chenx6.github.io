<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>关于 C 语言编译的那些破事 - 二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <div class="post">
    <h2 class="post-title">关于 C 语言编译的那些破事</h2>
    <span class="post-date">2022-05-21</span>
    
  
    
      <a href="https://chenx6.github.io/tags/cpp/">#cpp</a>
    
      <a href="https://chenx6.github.io/tags/c/">#c</a>
    
      <a href="https://chenx6.github.io/tags/compile/">#compile</a>
    
  

    <aside class="toc">
      
      <details>
        <summary>Tabel of contents</summary>
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#编译过程简述">编译过程简述</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#编译系统">编译系统</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#Meson">Meson</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#CMake">CMake</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#Makefile">Makefile</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#库管理工具">库管理工具</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#pkg-config">pkg-config</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#编译器">编译器</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#GCC编译选项">GCC编译选项</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#使用_zig_cc_进行跨平台编译">使用 zig cc 进行跨平台编译</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#环境配置">环境配置</a>
            
            <ul>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#Docker/Podman">Docker&#x2F;Podman</a>
              </li>
              
              <li>
                <a href="https://chenx6.github.io/post/compile_cheatsheet/#Glibc_symver">Glibc symver</a>
              </li>
              
            </ul>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/compile_cheatsheet/#Refs">Refs</a>
            
          </li>
          
        </ul>
      </details>
      
    </aside>
    <p>C 和 C++ 的编译是真的痛苦，会出现一堆离谱的问题。所以我特地写一篇文章讲一下这些破事，并且提供一些样例代码方便复制黏贴。</p>
<h2 id="编译过程简述">编译过程简述</h2>
<p>在网上能找到一堆的编译流程相关的博客，而且肯定比我讲的正确，所以这里我就简单概括下。</p>
<p>现在很少有程序能只依赖与 C 标准库和系统 API 了，所以会有一堆的外部依赖库。要想编译成功，得让编译器和链接器都知道去哪找这些库，怎么链接上。于是就有了一堆的编译管理工具。像 CMake 和 Meson 是负责生成编译的脚本，make 和 ninja 则是负责执行编译任务，然后是 gcc 和 clang 将代码编译成目标文件，最后有 ld, gold, mold 将目标文件进行链接生成可执行文件。</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">CMake -&gt; make  -&gt; gcc   -&gt; ld   -&gt; 可执行文件
Meson    ninja    clang    gold
Bazel    ...      zig cc   lld
...               ...      mold
                           ...
</span></code></pre>
<h2 id="编译系统">编译系统</h2>
<h3 id="Meson">Meson</h3>
<p>样例代码</p>
<pre data-lang="meson" class="language-meson z-code"><code class="language-meson" data-lang="meson"><span class="z-text z-plain"># 指定项目名称，使用语言，默认选项
project(&#39;project name&#39;, &#39;cpp&#39;
        default_options : [&#39;c_std=c11&#39;, &#39;cpp_std=c++11&#39;])
# 指定头文件位置
incdir = include_directories(&#39;include&#39;)
#（可选）使用 math 库
cc = meson.get_compiler(&#39;c&#39;)
m_dep = cc.find_library(&#39;m&#39;)
#（可选）使用 `dependency` 寻找库依赖
zdep = dependency(&#39;zlib&#39;, version: &#39;&gt;=1.2.8&#39;)
#（可选）子目录
subdir(&#39;tests&#39;)
# 指定代码文件位置，头文件位置来生成可执行文件
utils = [&#39;src/logger.cpp&#39;, &#39;src/utils.cpp&#39;]
# 可执行文件的相关设置
executable(&#39;client&#39;, &#39;src/main_client.cpp&#39;, &#39;src/client.cpp&#39;, utils, 
           include_directories : incdir,
           dependencies : m_dep
           cpp_args: [],
           c_args: [],
           link_args : &#39;&#39;)
# 在 executable 函数中添加下面的设置可以编译 32 位，静态链接的程序
#    cpp_args: [&#39;-m32&#39;, &#39;-static&#39;],
#    c_args: [&#39;-m32&#39;, &#39;-static&#39;],
#    link_args : &#39;-m32&#39;
</span></code></pre>
<p>跨平台编译配置文件</p>
<pre data-lang="ini" class="language-ini z-code"><code class="language-ini" data-lang="ini"><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[binaries]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">c</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;aarch64-linux-gnu-gcc&#39;</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">cpp</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;aarch64-linux-gnu-g++&#39;</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ar</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;aarch64-linux-gnu-ar&#39;</span>

<span class="z-storage z-type z-genconfig">[host_machine]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">system</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;linux&#39;</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">cpu_family</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;aarch64&#39;</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">cpu</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;aarch64&#39;</span>
<span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">endian</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;little&#39;</span>

<span class="z-storage z-type z-genconfig">[properties]
</span><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">sys_root</span> <span class="z-keyword z-operator z-genconfig">=</span></span> <span class="z-string z-quoted z-signle z-genconfig">&#39;/usr/aarch64-linux-gnu/&#39;</span>
</span></code></pre>
<p>常用编译命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 生成编译所需文件</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">meson</span></span><span class="z-meta z-function-call z-arguments z-shell"> setup builddir<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>wipe</span></span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Debug 编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">meson</span></span><span class="z-meta z-function-call z-arguments z-shell"> setup<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>buildtype</span> debug<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>reconfigure</span></span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">meson</span></span><span class="z-meta z-function-call z-arguments z-shell"> compile<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>C</span> builddir</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 跨平台编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">meson</span></span><span class="z-meta z-function-call z-arguments z-shell"> setup<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>cross-file</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">跨平台编译配置文件</span></span>.ini builddir</span>
</span></code></pre>
<p>更多的内容参考 <a href="https://chenx6.github.io/post/compile_cheatsheet/#refs">#refs</a></p>
<h3 id="CMake">CMake</h3>
<p>样例代码</p>
<pre data-lang="cmake" class="language-cmake z-code"><code class="language-cmake" data-lang="cmake"><span class="z-source z-cmake"><span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 指定项目名字，CMake 版本要求，C++ 版本要求</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-project z-cmake">project</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">project_name</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-cmake_minimum_required z-cmake">cmake_minimum_required</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-variable z-parameter z-VERSION z-cmake">VERSION</span> <span class="z-meta z-string z-unquoted z-cmake">3.0</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-set z-cmake">set</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-variable z-other z-readwrite z-assignment z-cmake">CXX_STANDARD</span> <span class="z-meta z-string z-unquoted z-cmake">11</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>

<span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 使用 CMake 管理的库</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-find_package z-cmake">find_package</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">OpenCV</span> <span class="z-variable z-parameter z-REQUIRED z-cmake">REQUIRED</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-include_directories z-cmake">include_directories</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">OpenCV_INCLUDE_DIRS</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-link_directories z-cmake">link_directories</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">OpenCV_LIBRARY_DIRS</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>

<span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 使用由 pkg-config 管理的库</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-find_package z-cmake">find_package</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">PkgConfig</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-generic z-cmake"><span class="z-variable z-function z-generic z-cmake">pkg_search_module</span></span><span class="z-meta z-function-call z-arguments z-generic z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-variable z-parameter z-generic z-cmake">LIBNOTIFY</span> <span class="z-variable z-parameter z-generic z-cmake">REQUIRED</span> <span class="z-meta z-string z-unquoted z-cmake">libnotify</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-include_directories z-cmake">include_directories</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">LIBNOTIFY_INCLUDE_DIRS</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>

<span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 指定头文件目录</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-include_directories z-cmake">include_directories</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">./include</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 扫描目录，获得目录下源代码位置</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-aux_source_directory z-cmake">aux_source_directory</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">./src</span> <span class="z-meta z-string z-unquoted z-cmake">SRC</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_executable z-cmake">add_executable</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-string z-unquoted z-cmake">name</span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">SRC</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> 链接上库</span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-target_link_libraries z-cmake">target_link_libraries</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">OpenCV_LIBS</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">LIBNOTIFY_LIBRARIES</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></code></pre>
<p>常用命令</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> build</span> <span class="z-keyword z-operator z-logical z-and z-shell">&amp;&amp;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cmake</span></span><span class="z-meta z-function-call z-arguments z-shell"> ..</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Debug 编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cmake</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>DCMAKE_BUILD_TYPE</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>Debug ..</span>
</span></code></pre>
<h3 id="Makefile">Makefile</h3>
<p>Makefile 的可读性真的是灾难级别的，下面这篇文章图文并茂，讲的很好，推荐阅读！！！</p>
<p><a href="https://zhuanlan.zhihu.com/p/47390641">Makefile由浅入深--教程、干货</a></p>
<h2 id="库管理工具">库管理工具</h2>
<h3 id="pkg-config">pkg-config</h3>
<table><thead><tr><th>选项</th><th>作用</th><th>样例</th></tr></thead><tbody>
<tr><td><code>--cflags</code></td><td>查询这个库的所需要的 CFLAGS</td><td><code>pkg-config --cflags glib-2.0</code></td></tr>
<tr><td><code>--libs</code></td><td>查询链接上这个库的所需要的选项</td><td><code>pkg-config --libs zlib</code></td></tr>
<tr><td><code>–-list-all</code></td><td>列出所有的，可以被查找到的库</td><td><code>pkg-config –-list-all \| rg $库</code></td></tr>
</tbody></table>
<p>设置 pkg-config 搜索路径</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">PKG_CONFIG_PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">/usr/lib/pkgconfig/:<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PKG_CONFIG_PATH</span></span></span></span>
</span></code></pre>
<p>官方文档参考 <a href="https://chenx6.github.io/post/compile_cheatsheet/#refs">#refs</a></p>
<h2 id="编译器">编译器</h2>
<h3 id="GCC编译选项">GCC编译选项</h3>
<h4 id="链接">链接</h4>
<table><thead><tr><th>选项</th><th>作用</th><th>样例</th></tr></thead><tbody>
<tr><td><code>-l$library</code></td><td>链接上某个库</td><td><code>-lm</code></td></tr>
<tr><td><code>-static</code></td><td>静态链接库</td><td></td></tr>
<tr><td><code>-static-libstdc++</code></td><td>静态链接libstdc++</td><td></td></tr>
<tr><td><code>-Wl,$option</code></td><td>将链接选项传递给 ld</td><td></td></tr>
</tbody></table>
<h4 id="目录搜索">目录搜索</h4>
<table><thead><tr><th>选项</th><th>作用</th><th>样例</th></tr></thead><tbody>
<tr><td><code>-I $dir</code></td><td>（大写的i）头文件搜索路径</td><td><code>-I ./include</code></td></tr>
<tr><td><code>-L$dir</code></td><td>库文件搜索路径</td><td><code>-L./lib</code></td></tr>
<tr><td><code>--sysroot=$dir</code></td><td>头文件和库的搜索路径</td><td><code>--sysroot=/usr</code></td></tr>
</tbody></table>
<h3 id="使用_zig_cc_进行跨平台编译">使用 zig cc 进行跨平台编译</h3>
<p>zig cc 真是跨平台编译救星，下面演示下常见命令。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 显示支持的 libc</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">zig</span></span><span class="z-meta z-function-call z-arguments z-shell"> targets</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">jq</span></span><span class="z-meta z-function-call z-arguments z-shell"> .libc</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 直接编译</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">zig</span></span><span class="z-meta z-function-call z-arguments z-shell"> cc <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">文件</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>target</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">目标</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">zig</span></span><span class="z-meta z-function-call z-arguments z-shell"> cc hello.c<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>target</span> i386-linux-musl<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>static</span></span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 让 make 等工具使用</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> CC=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>zig cc<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> CXX=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>zig c++<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>参考文章 <a href="https://chenx6.github.io/post/compile_cheatsheet/#refs">#refs</a></p>
<h2 id="环境配置">环境配置</h2>
<h3 id="Docker/Podman">Docker/Podman</h3>
<p>Ubuntu image，添加 32 位支持，安装编译工具链，库和 CMake</p>
<pre data-lang="dockerfile" class="language-dockerfile z-code"><code class="language-dockerfile" data-lang="dockerfile"><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> ubuntu:<span class="z-entity z-name z-enum z-tag-digest">18.04</span>

<span class="z-keyword z-control z-dockerfile">RUN </span>dpkg --add-architecture i386 &amp;&amp; \
    apt update &amp;&amp; \
    apt install -y gcc-multilib g++-multilib build-essential cmake
</span></code></pre>
<p>CentOS image，安装编译工具，相关的库和 meson, ninja</p>
<pre data-lang="dockerfile" class="language-dockerfile z-code"><code class="language-dockerfile" data-lang="dockerfile"><span class="z-source z-dockerfile"><span class="z-keyword z-control z-dockerfile">FROM</span> amd64/centos:<span class="z-entity z-name z-enum z-tag-digest">7</span>

<span class="z-keyword z-control z-dockerfile">RUN </span>yum install python3 \
        glibc-devel.i686 glibc-devel.x86_64 \
        libgcc.i686 libgcc.x86_64 \
        libstdc++-devel.i686 libstdc++-devel \
        glibc-static glibc-static.i686 \
        libstdc++-static libstdc++-static.i686 -y &amp;&amp; \
    yum group install <span class="z-string z-quoted z-double z-dockerfile"><span class="z-punctuation z-definition z-string z-begin z-dockerfile">&quot;</span>Development Tools<span class="z-punctuation z-definition z-string z-end z-dockerfile">&quot;</span></span> -y

<span class="z-keyword z-control z-dockerfile">RUN </span>python3 -m pip install cmake meson ninja -i https://opentuna.cn/pypi/web/simple
</span></code></pre>
<p>使用容器进行编译。设置成运行完后删除，并将当前目录映射到 &quot;/src&quot; 目录下，启动名字为 <code>$容器名字</code> 的容器。</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">podman</span></span><span class="z-meta z-function-call z-arguments z-shell"> run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>rm</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>v</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pwd</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>:/src<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>it</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">容器名字</span></span></span>
</span></code></pre>
<h3 id="Glibc_symver">Glibc symver</h3>
<p>有时候在新系统上编译的可执行文件，在旧系统上运行时，会产生 &quot;找不到函数&quot; 错误。这时候可以通过指定 symver 来进行兼容旧版本。具体细节可以参考 <a href="https://chenx6.github.io/post/compile_cheatsheet/#Refs">#Refs</a> 中的 &quot;All about symbol versioning&quot;，或者使用 &quot;wheybags/glibc_version_header&quot; 这个项目。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__asm__</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>.symver fopen,fopen@GLIBC_2.2.5<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h2 id="Refs">Refs</h2>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc-11.3.0/gcc/">https://gcc.gnu.org/onlinedocs/gcc-11.3.0/gcc/</a></li>
<li><a href="https://www.freedesktop.org/wiki/Software/pkg-config">https://www.freedesktop.org/wiki/Software/pkg-config</a></li>
<li><a href="https://mesonbuild.com/howtox.html">https://mesonbuild.com/howtox.html</a></li>
<li><a href="https://mesonbuild.com/Meson-sample.html">https://mesonbuild.com/Meson-sample.html</a></li>
<li><a href="https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html">https://andrewkelley.me/post/zig-cc-powerful-drop-in-replacement-gcc-clang.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/314912277">All about symbol versioning</a></li>
<li><a href="https://github.com/wheybags/glibc_version_header">https://github.com/wheybags/glibc_version_header</a></li>
</ul>

  </div>
</div>

</body>

</html>