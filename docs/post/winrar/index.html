<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>WinRAR 最近的 2 个漏洞分析&#x2F;复现 - 二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <div class="post">
    <h2 class="post-title">WinRAR 最近的 2 个漏洞分析&#x2F;复现</h2>
    <span class="post-date">2023-09-30</span>
    
  
    
      <a href="https://chenx6.github.io/tags/re/">#re</a>
    
  

    <aside class="toc">
      
      <details>
        <summary>Table of contents</summary>
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/winrar/#CVE-2023-40477">CVE-2023-40477</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/winrar/#CVE-2023-38831">CVE-2023-38831</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/winrar/#总结">总结</a>
            
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/winrar/#Refs">Refs</a>
            
          </li>
          
        </ul>
      </details>
      
    </aside>
    <p>其实这个漏洞的公告一出来我就开始进行分析了，只是因为空闲时间的利用非常的差，所以分析的很慢，最多就确认了漏洞修复地点。后来大佬们详细的分析就发出来了，所以这篇文章只能算是复现文章了...</p>
<h2 id="CVE-2023-40477">CVE-2023-40477</h2>
<p>从下面的官方公告中可以知道代码修复的地方是在 RAR4 恢复卷的处理代码中。</p>
<blockquote>
<p>Critical Bug: CVE-2023-40477. The vulnerability allows remote attackers to execute arbitrary code on affected installations. User interaction is required to exploit this vulnerability. This is fixed in the RAR4 recovery volume processing code.</p>
</blockquote>
<p>ZDI 的公告也是一样的说法。</p>
<blockquote>
<p>The specific flaw exists within the processing of recovery volumes. The issue results from the lack of proper validation of user-supplied data, which can result in a memory access past the end of an allocated buffer. An attacker can leverage this vulnerability to execute code in the context of the current process.</p>
</blockquote>
<p>WinRAR 的 unrar 代码是可以下载的，所以通过 <a href="https://github.com/pmachapman/unrar">GitHub 上的代码仓库</a> 可以下载和对比不同版本的代码，在 commit <a href="https://github.com/pmachapman/unrar/commit/2464dd1c376585f0e4ce51157d50aea358a50bbc">2464dd1c376585f0e4ce51157d50aea358a50bbc</a> 可以看到下面的修改。加强了对数据的校验，防止整数溢出导致越界写入。</p>
<pre data-lang="diff" class="language-diff z-code"><code class="language-diff" data-lang="diff"><span class="z-source z-diff">diff --git a/recvol3.cpp b/recvol3.cpp
</span><span class="z-source z-diff">index ecf6dd3..0138d0f 100644
</span><span class="z-source z-diff"><span class="z-meta z-diff z-header z-from-file"><span class="z-meta z-header z-from-file z-diff"><span class="z-punctuation z-definition z-from-file z-diff">---</span> a/recvol3.cpp
</span></span></span><span class="z-source z-diff"><span class="z-meta z-diff z-header z-to-file"><span class="z-meta z-header z-to-file z-diff"><span class="z-punctuation z-definition z-to-file z-diff">+++</span> b/recvol3.cpp
</span></span></span><span class="z-source z-diff"><span class="z-meta z-diff z-range z-unified"><span class="z-meta z-range z-unified z-diff"><span class="z-punctuation z-definition z-range z-diff">@@</span> <span class="z-meta z-toc-list z-line-number z-diff">-226,7 +226,7</span> <span class="z-punctuation z-definition z-range z-diff">@@</span> <span class="z-entity z-name z-section z-diff">bool RecVolumes3::Restore(CommandData *Cmd,const wchar *Name,bool Silent)</span>
</span></span></span><span class="z-source z-diff">       if (WrongParam)
</span><span class="z-source z-diff">         continue;
</span><span class="z-source z-diff">     }
</span><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span>    if (P[1]+P[2]&gt;255)
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    if (P[0]&lt;=0 || P[1]&lt;=0 || P[2]&lt;=0 || P[1]+P[2]&gt;255 || P[0]+P[2]-1&gt;255)
</span></span><span class="z-source z-diff">       continue;
</span><span class="z-source z-diff">     if (RecVolNumber!=0 &amp;&amp; RecVolNumber!=P[1] || FileNumber!=0 &amp;&amp; FileNumber!=P[2])
</span><span class="z-source z-diff">     {
</span><span class="z-source z-diff"><span class="z-meta z-diff z-range z-unified"><span class="z-meta z-range z-unified z-diff"><span class="z-punctuation z-definition z-range z-diff">@@</span> <span class="z-meta z-toc-list z-line-number z-diff">-238,7 +238,14</span> <span class="z-punctuation z-definition z-range z-diff">@@</span> <span class="z-entity z-name z-section z-diff">bool RecVolumes3::Restore(CommandData *Cmd,const wchar *Name,bool Silent)</span>
</span></span></span><span class="z-source z-diff">     wcsncpyz(PrevName,CurName,ASIZE(PrevName));
</span><span class="z-source z-diff">     File *NewFile=new File;
</span><span class="z-source z-diff">     NewFile-&gt;TOpen(CurName);
</span><span class="z-source z-diff"><span class="z-markup z-deleted z-diff"><span class="z-punctuation z-definition z-deleted z-diff">-</span>    SrcFile[FileNumber+P[0]-1]=NewFile;
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    // This check is redundant taking into account P[I]&gt;255 and P[0]+P[2]-1&gt;255
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    // checks above. Still we keep it here for better clarity and security.
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    int SrcPos=FileNumber+P[0]-1;
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    if (SrcPos&lt;0 || SrcPos&gt;=ASIZE(SrcFile))
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>      continue;
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    SrcFile[SrcPos]=NewFile;
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>
</span></span><span class="z-source z-diff">     FoundRecVolumes++;
</span><span class="z-source z-diff"> 
</span><span class="z-source z-diff">     if (RecFileSize==0)
</span></code></pre>
<p>使用 Bindiff 找到类似特征，可以在 6.22.0 简体中文版本的 unrar+0x1BC03 (14001BC03) 地址找到修改。</p>
<p>查看源代码可以确认函数从恢复文件中的文件末尾中获取文件分卷数，并存放在 <code>P</code> 数组里。经过旧版本的溢出检查后，通过 <code>P</code> 数组的运算，往 <code>RecVolumes3 RecVol</code> 对象的私有成员 <code>File *SrcFile[256]</code> 里写入一个 <code>File *</code> 指针。而数组写入地址的索引是 <code>P[2]+P[0]-1</code>。</p>
<p>通过创建 RAR 压缩包，调整切分为分卷文本框的值来产生分卷，在“高级 - 分卷”里启用 1 个恢复卷，然后开启脚本修改 RAR 的 .rev 文件，删除一个分卷，通过 <code>unrar t test_delete.part01.rar</code> 即可触发漏洞，实现越界写入一个函数指针。这里我对 wildptr.io 的脚本进行小幅修改，让脚本将 P 数组的内容设置为 <code>[0xf0, 0x00, 0xf0]</code>。</p>
<pre data-lang="python" class="language-python z-code"><code class="language-python" data-lang="python"><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">zlib</span></span></span>
</span><span class="z-source z-python"><span class="z-meta z-statement z-import z-python"><span class="z-keyword z-control z-import z-python">import</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">calculate_crc32</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">data</span><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">	<span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">crc_value</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">zlib</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">crc32</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">data</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">	<span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">struct</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">pack</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">&lt;I<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">crc_value</span></span> <span class="z-keyword z-operator z-arithmetic z-python">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>FFFFFFFF</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-statement z-with z-python"><span class="z-keyword z-control z-flow z-with z-python">with</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">open</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">test_delete.part01.rev.origin<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">rb<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-meta z-statement z-with z-python"><span class="z-keyword z-control z-flow z-with z-as z-python">as</span></span></span><span class="z-meta z-statement z-with z-python"> <span class="z-meta z-generic-name z-python">f</span><span class="z-punctuation z-section z-block z-with z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">data</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">f</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">read</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">p</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-type z-python">bytes</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>f0</span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>00</span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>f0</span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">new_data</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">data</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-punctuation z-separator z-slice z-python">:</span><span class="z-keyword z-operator z-arithmetic z-python">-</span><span class="z-constant z-numeric z-integer z-decimal z-python">7</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">p</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">calculate_crc32</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">data</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-punctuation z-separator z-slice z-python">:</span><span class="z-keyword z-operator z-arithmetic z-python">-</span><span class="z-constant z-numeric z-integer z-decimal z-python">7</span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-arithmetic z-python">+</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">p</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-statement z-with z-python"><span class="z-keyword z-control z-flow z-with z-python">with</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">open</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">test_delete.part01.rev<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">&quot;</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">wb<span class="z-punctuation z-definition z-string z-end z-python">&quot;</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-meta z-statement z-with z-python"><span class="z-keyword z-control z-flow z-with z-as z-python">as</span></span></span><span class="z-meta z-statement z-with z-python"> <span class="z-meta z-generic-name z-python">fw</span><span class="z-punctuation z-section z-block z-with z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">fw</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">write</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">new_data</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span></code></pre>
<p>在调试器中可以看到数组索引(rax 寄存器)已经越界到 0x1e2(482)，超过了 256，但是这样越界写并不能造成程序崩溃或者任意代码执行，因为写入的地址是往高地址方向越界，在调试器里看高地址空间都没什么重要数据...</p>
<p><img src="/images/winrar.png" alt="x64dbg0" /></p>
<p>后来我阅读了别人的分析文章，发现如果要造成崩溃，或覆盖返回地址的效果，可以用旧风格文件名中填充 <code>P</code> 数组，而不是从恢复文件中获得 <code>P</code> 数组的值。由于代码逻辑的问题，可以从文件名中读取出负数，从而实现覆盖返回地址。不过即使覆盖了返回地址，也只能造成程序崩溃，应该是没法造成代码执行。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c">    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>NewStyle<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span><span class="z-source z-c">    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> ... <span class="z-punctuation z-definition z-comment z-c">*/</span></span> 
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">    <span class="z-keyword z-control z-c">else</span>
</span><span class="z-source z-c">    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      wchar <span class="z-keyword z-operator z-c">*</span>Dot<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">GetExt</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">CurName</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>Dot<span class="z-keyword z-operator z-comparison z-c">==</span><span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-continue z-c">continue</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-storage z-type z-c">bool</span> WrongParam<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">for</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-support z-type z-sys-types z-c">size_t</span> I<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>I<span class="z-keyword z-operator z-comparison z-c">&lt;</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">ASIZE</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">P</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>I<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-c">do</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">          Dot<span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-punctuation z-section z-block z-end z-c">}</span></span> <span class="z-keyword z-control z-c">while</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">IsDigit</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">*</span>Dot</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span> Dot<span class="z-keyword z-operator z-comparison z-c">&gt;=</span>CurName<span class="z-keyword z-operator z-arithmetic z-c">+</span>BaseNamePartLength<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        P<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>I<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">atoiw</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">Dot<span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>P<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>I<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-keyword z-operator z-comparison z-c">==</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span> <span class="z-keyword z-operator z-arithmetic z-c">||</span> P<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>I<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-keyword z-operator z-comparison z-c">&gt;</span><span class="z-constant z-numeric z-integer z-decimal z-c">255</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">          WrongParam<span class="z-keyword z-operator z-assignment z-c">=</span><span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">      <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>WrongParam<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-continue z-c">continue</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<h2 id="CVE-2023-38831">CVE-2023-38831</h2>
<p>这个漏洞应该利用价值比较高，并且网上分析也很多，所以我就简单分析下。下面的代码是判断两文件名字是否相等函数的部分代码，可以看到在用 <code>wcsncmp</code> 比较文件文件名时候，只用到了第一个文件名字的长度(变量 <code>a1_len</code>)，而没有用到第二个文件名字的长度，而后面半部分代码则是检查文件名字的结尾是否为 '' '/' 或者 0 字节。这就会导致如果压缩文件中存在相同名字的文件夹和文件时，例如 "test.txt/" 文件夹 "test.txt" 文件，两者的内容都会被释放到临时目录。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c">    v7 <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span><span class="z-constant z-numeric z-integer z-decimal z-c">1<span class="z-invalid z-illegal z-numeric z-suffix z-c">i64</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">    a1_len <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span><span class="z-constant z-numeric z-integer z-decimal z-c">1<span class="z-invalid z-illegal z-numeric z-suffix z-c">i64</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">    <span class="z-keyword z-control z-c">do</span>
</span><span class="z-source z-c">      <span class="z-keyword z-operator z-arithmetic z-c">++</span>a1_len<span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">    <span class="z-keyword z-control z-c">while</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> a1<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>a1_len<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">int</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">unsigned</span> <span class="z-support z-type z-microsoft z-c">__int16</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>a3 <span class="z-keyword z-operator z-arithmetic z-c">-</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span> <span class="z-keyword z-operator z-comparison z-c">&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span><span class="z-source z-c">    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>a3 <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>80000000</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">        neq <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">sub_1400AF168</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">a1<span class="z-punctuation z-separator z-c">,</span> a2<span class="z-punctuation z-separator z-c">,</span> a1_len</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">else</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">        neq <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">wcsncmp</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">a1<span class="z-punctuation z-separator z-c">,</span> a2<span class="z-punctuation z-separator z-c">,</span> a1_len</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> <span class="z-keyword z-operator z-arithmetic z-c">!</span>neq <span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        v10 <span class="z-keyword z-operator z-assignment z-c">=</span> a2<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>a1_len<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> v10 <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&#39;</span><span class="z-constant z-character z-escape z-c">\\</span><span class="z-punctuation z-definition z-string z-end z-c">&#39;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">||</span> v10 <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&#39;</span>/<span class="z-punctuation z-definition z-string z-end z-c">&#39;</span></span> <span class="z-keyword z-operator z-arithmetic z-c">||</span> <span class="z-keyword z-operator z-arithmetic z-c">!</span>v10 <span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">          <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">      <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">      <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span> v3 <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>配合上 <code>ShellExecuteExW</code> 对文件的处理，就造成了点击一个文件，让另一个文件被调用执行的情况...详细分析请看 <a href="https://chenx6.github.io/post/winrar/#refs">Refs</a></p>
<h2 id="总结">总结</h2>
<p>CVE-2023-40477 的漏洞应该是可以被避免的，存储数组索引的数据，应该使用 unsigned 类型，并且在通过不可信任的数据，访问数组时候需要检查边界。而 CVE-2023-38831 则是碰上了一个逻辑问题，在比较字符串时候没有比较长度。</p>
<h2 id="Refs">Refs</h2>
<ul>
<li><a href="https://www.win-rar.com/singlenewsview.html?&amp;L=0&amp;tx_ttnews%5Btt_news%5D=232&amp;cHash=c5bf79590657e32554c6683296a8e8aa">WinRAR 6.23 final released</a></li>
<li><a href="https://www.zerodayinitiative.com/advisories/ZDI-23-1152/">RARLAB WinRAR Recovery Volume Improper Validation of Array Index Remote Code Execution Vulnerability</a></li>
<li><a href="https://www.rarlab.com/vuln_rev3_names.html">CVE-2023-40477 vulnerability</a></li>
<li><a href="https://wildptr.io/winrar-cve-2023-40477-poc-new-vulnerability-winrar-security-research/">“Game of Rars” – Exploring a New Remote Code Execution Vulnerability in WinRAR with Proof-of-Concept (CVE-2023-40477)</a></li>
<li><a href="https://www.richardosgood.com/posts/cve---2023---4047-root-cause-analysis/">CVE-2023-40477 Root Cause Analysis</a></li>
<li><a href="https://paper.seebug.org/3036/">CVE-2023-38831 WinRAR 漏洞分析</a></li>
<li><a href="https://www.cnblogs.com/GoodFish-/archive/2023/09/21/17715977.html">Winrar代码执行漏洞(CVE-2023-38831)的原理分析</a></li>
</ul>

  </div>
  
    <script src="https://utteranc.es/client.js"
          repo="chenx6/chenx6.github.io"
          issue-term="pathname"
          label="comment"
          theme="preferred-color-scheme"
          crossorigin="anonymous"
          async>
    </script>
  
</div>

  
    <footer>2020-∞ chenx6 本作品采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。</footer>
  
</body>

</html>