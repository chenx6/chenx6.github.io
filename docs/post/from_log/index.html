<!DOCTYPE html>
<html lang="zh-hans">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.101.0" />


<link rel="icon" href="data:;base64,iVBORw0KGgo=">


<title>从日志函数中回复无符号的函数名字 - 二进制咸鱼的自我救赎</title>


<meta name="author" content="chen_null" />



<meta name="keywords" content="ida, python" />


<meta property="og:title" content="从日志函数中回复无符号的函数名字" />
<meta name="twitter:title" content="从日志函数中回复无符号的函数名字" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chenx6.github.io/post/from_log/" /><meta property="og:description" content="在逆向二进制程序中，经常碰到将程序 strip 了，但是日志函数中保留着函数名字的情况。所以写文记录在这种情况下，使用 IDAPython 恢复函数名字的过程。 日志函数长什么样 下面是我手写的一个日志函数。主要有几个部分： 日志级别 Lo" />
<meta name="twitter:description" content="在逆向二进制程序中，经常碰到将程序 strip 了，但是日志函数中保留着函数名字的情况。所以写文记录在这种情况下，使用 IDAPython 恢复函数名字的过程。 日志函数长什么样 下面是我手写的一个日志函数。主要有几个部分： 日志级别 Lo" /><meta name="twitter:card" content="summary" /><meta property="article:published_time" content="2022-07-24T00:00:00+00:00" /><meta property="article:modified_time" content="2022-07-24T00:00:00+00:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>




<link rel="stylesheet" href="https://chenx6.github.io/assets/css/fuji.min.css" />








</head>

<body
  data-theme="auto"
  data-theme-auto='false'
  >
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://chenx6.github.io/">二进制咸鱼的自我救赎</a>
            
            <span class="title-sub">幸福往往是摸的透彻，而敬业的心却往往隐藏。</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://chenx6.github.io/post/from_log/">从日志函数中回复无符号的函数名字</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-07-24</span>



<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/ida">ida</a>&nbsp;<a href="/tags/python">python</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <p>在逆向二进制程序中，经常碰到将程序 strip 了，但是日志函数中保留着函数名字的情况。所以写文记录在这种情况下，使用 IDAPython 恢复函数名字的过程。</p>
<h2 id="日志函数长什么样">日志函数长什么样</h2>
<p>下面是我手写的一个日志函数。主要有几个部分：</p>
<ul>
<li>日志级别 <code>LogLevel</code>，记录日志的最低级别 <code>do_log_level</code>，用来在不同的情况下过滤日志。</li>
<li>日志文件 <code>log_file</code>，将日志输出到对应的文件中。</li>
<li>记录日志的函数 <code>logger_log</code>，还有几个辅助记录日志的宏。在宏中则是将函数的名称也记录了下来，方便后期调试。</li>
</ul>
<p>代码也非常简单粗暴，唯一需要注意的是 <code>logger_log</code> 用了 C 中的变长函数参数，并且在相关的宏中用了 gcc 扩展 “GCC variadic macro” 来处理宏中的变长参数。</p>
<pre><code class="language-c">#include &lt;stdarg.h&gt;
#include &lt;stdio.h&gt;

enum LogLevel { DEBUG = 0, INFO, WARNING, ERROR };

static FILE *log_file = NULL;
static int do_log_level = 0;

/// @brief init log file and log level
void logger_init(const char *file_path, int log_level) {
  if (file_path) {
    log_file = fopen(file_path, &quot;a+&quot;);
  } else {
    log_file = stderr;
  }
  do_log_level = log_level;
}

/// @brief do log
void logger_log(int level, const char *fmt, ...) {
  if (log_file == NULL) {
    return;
  }
  if (level &lt; do_log_level) {
    return;
  }
  va_list vl;
  va_start(vl, fmt);
  vfprintf(log_file, fmt, vl);
  fputc('\n', log_file);
  va_end(vl);
}

#define LOG_DEBUG(fmt, ...)                                                    \
  logger_log(DEBUG, &quot;[DEBUG]   [%s] &quot; fmt, __FUNCTION__, ##__VA_ARGS__);
#define LOG_INFO(fmt, ...)                                                     \
  logger_log(INFO, &quot;[INFO]    [%s] &quot; fmt, __FUNCTION__, ##__VA_ARGS__);
#define LOG_WARNING(fmt, ...)                                                  \
  logger_log(WARNING, &quot;[WARNING] [%s] &quot; fmt, __FUNCTION__, ##__VA_ARGS__);
#define LOG_ERROR(fmt, ...)                                                    \
  logger_log(ERROR, &quot;[ERROR]   [%s] &quot; fmt, __FUNCTION__, ##__VA_ARGS__);
</code></pre>
<p>接下来是一点测试代码</p>
<pre><code class="language-c">int a_important_function() {
  LOG_WARNING(&quot;Warning world, return value: %d&quot;, 114514);
  return 1919810;
}

int main(int argc, char *argv[]) {
  logger_init(NULL, INFO);
  LOG_DEBUG(&quot;Debug, world!&quot;);
  LOG_INFO(&quot;Info, world!&quot;);
  // logger_log(INFO, &quot;[INFO]   [%s] Info, world!&quot;, __FUNCTION__);
  int ret = 0;
  if ((ret = a_important_function()) != 0) {
    LOG_ERROR(&quot;Error world, exit code: %d&quot;, ret);
  }
  return 0;
}
</code></pre>
<p>下面是程序运行后的输出，可以看到 DEBUG 级别低于要记录的 INFO 级别，所以 DEBUG 级别的日志没有输出。</p>
<pre><code class="language-bash">$ gcc test.c -o test -O0 -Wall
$ ./test                   
[INFO]    [main] Info, world!
[WARNING] [a_important_function] Warning world, return value: 114514
[ERROR]   [main] Error world, exit code: 1919810
</code></pre>
<h2 id="在-ida-中上面的代码长什么样">在 IDA 中，上面的代码长什么样</h2>
<p>在反汇编结果中，可以看到虽然 DEBUG 级别的日志没有输出，但是相关的函数调用仍然在代码中保留着。并且每个日志函数的调用，在参数中都有函数名字。在这种情况下，就可以使用 IDAPython 进行自动化提取函数名字并且恢复回去了。</p>
<pre><code class="language-c">int sub_401156(int a1, const char *a2, ...)
{
  int result; // eax
  gcc_va_list arg; // [rsp+8h] [rbp-D0h]

  result = (signed int)stream;
  if ( stream )
  {
    if ( dword_404070 &lt;= a1 )
    {
      va_start(arg, a2);
      vfprintf(stream, a2, arg);
      result = fputc(10, stream);
    }
  }
  return result;
}

__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  char *a4; // [rsp+1Ch] [rbp-4h]

  sub_401156(0LL, 1LL, a3);
  sub_4011A0(0, &quot;[DEBUG]   [%s] Debug, world!&quot;, &quot;main&quot;, a2);
  sub_4011A0(1, &quot;[INFO]    [%s] Info, world!&quot;, &quot;main&quot;);
  LODWORD(a4) = sub_40127B(1LL, &quot;[INFO]    [%s] Info, world!&quot;);
  if ( (_DWORD)a4 )
    sub_4011A0(3, &quot;[ERROR]   [%s] Error world, exit code: %d&quot;, &quot;main&quot;, (unsigned int)a4);
  return 0LL;
}
</code></pre>
<h2 id="idapython-登场">IDAPython 登场</h2>
<p>下面是脚本。思路则是使用 <code>idautils.CodeRefsTo</code> 获取日志函数的调用，并且从调用处使用 <code>idaapi.get_arg_addrs</code> 获得带函数名字参数的地址，然后从这个地址读取出函数名字，调用 <code>idc.set_name</code> 重命名当前函数。</p>
<pre><code class="language-python">import idaapi
import idautils
import idc
import ida_ida

func_addr = 0x4011a0  # log function address, Use 'y' to declare argument's type first
# https://reverseengineering.stackexchange.com/questions/25301/getting-function-arguments-in-ida
name_idx = 2  # function name in log call position
# https://hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml
if idaapi.IDA_SDK_VERSION &lt;= 700:
    min_ea = idc.MinEA()
    max_ea = idc.MaxEA()
else:
    min_ea = ida_ida.inf_get_min_ea()
    max_ea = ida_ida.inf_get_max_ea()


def is_addr_invalid(addr):
    &quot;&quot;&quot;Check `addr` is valid address&quot;&quot;&quot;
    return (
        addr == 0
        or addr == 0xFFFFFFFF
        or addr == 0xFFFFFFFFFFFFFFFF
        or addr &lt; min_ea
        or addr &gt; max_ea
    )


def read_c_str(addr, limit=32):
    &quot;&quot;&quot;Read C string from `addr`&quot;&quot;&quot;
    if addr == 0 or addr == 0xFFFFFFFF or addr == 0xFFFFFFFFFFFFFFFF:
        return b&quot;&quot;
    curr_addr = addr
    ret = b&quot;&quot;
    while True:
        data = idc.get_bytes(curr_addr, 1)
        if data == b&quot;\x00&quot; or data == 0:
            break
        if curr_addr &gt; addr + limit:
            break
        ret += data
        curr_addr += 1
    return ret


def search_nearest_function(addr):
    &quot;&quot;&quot;Search function that `addr` belongs to&quot;&quot;&quot;
    prev_func = 0x0
    for func in idautils.Functions():
        if func &gt; addr:
            break
        prev_func = func
    return prev_func


refs = list(idautils.CodeRefsTo(func_addr, 0))
print(&quot;[+] ref len %d&quot; % len(refs))
for xref_addr in refs:
    # Get function argument
    args = idaapi.get_arg_addrs(xref_addr)
    if not args or len(args) &lt;= name_idx:
        print(&quot;[-] No args&quot;)
        continue
    # Get argument address
    arg_addr = args[name_idx]
    if is_addr_invalid(arg_addr):
        print(&quot;[-] Argument address is invalid&quot;)
        continue
    # Get argument's immendiate value
    insn = idaapi.insn_t()
    length = idaapi.decode_insn(insn, arg_addr)
    func_name_addr = insn.ops[1].value
    if is_addr_invalid(func_name_addr):
        print(&quot;[-] Function name address is invalid&quot;)
        continue
    # Get function name
    func_name = read_c_str(func_name_addr)
    func = search_nearest_function(xref_addr)
    print(&quot;[+] %x %s&quot; % (func, func_name))
    idc.set_name(func, func_name, 0)

</code></pre>
<p>有些地方需要注意：判断函数地址是否在程序运行虚拟地址，读取 C 式字符串，获得当前指令所属的函数地址是自己写的函数，可能有更好的内置函数来辅助判断。还有 <code>get_arg_addrs</code> 函数，获得的是给参数赋值的指令地址，例如对下面的代码，使用 <code>[&quot;%x&quot; % i for i in idaapi.get_arg_addrs(0x4012d6)]</code>，得到的返回值是 <code>['4012cc', '4012c7', '4012c2']</code>，而不是字符串地址，所以得对指令使用 <code>idaapi.decode_insn</code> 进行解码，获得立即数的地址，即字符串的地址。还有就是日志函数有可能类型定义有问题，会导致 <code>get_arg_addrs</code> 返回 None，这种情况下，对着日志函数按 &ldquo;y&rdquo; 对参数类型和数量进行编辑，编辑后再次运行脚本即可获取参数。</p>
<pre><code class="language-assembly">.text:00000000004012C2                 mov     edx, offset aMain ; &quot;main&quot;
.text:00000000004012C7                 mov     esi, offset aDebugSDebugWor ; &quot;[DEBUG]   [%s] Debug, world!&quot;
.text:00000000004012CC                 mov     edi, 0          ; a1
.text:00000000004012D1                 mov     eax, 0
.text:00000000004012D6                 call    sub_4011A0
</code></pre>
<p>代码运行结果如下，可以看到，补全了没有符号的 <code>a_important_function</code> 函数名字，达到了基本效果。</p>
<pre><code class="language-log">[+] ref len 4
[+] 40127b a_important_function
[+] 4012a4 main
[+] 4012a4 main
[+] 4012a4 main
</code></pre>
<h2 id="refs">Refs</h2>
<ul>
<li>The Beginner’s Guide to IDAPython Version 6.0</li>
<li><a href="https://reverseengineering.stackexchange.com/questions/25301/getting-function-arguments-in-ida" target="_blank">Getting function arguments in ida</a></li>
<li><a href="https://hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml" target="_blank">Porting from IDAPython 6.x-7.3, to 7.4</a></li>
</ul>

    </div>
</article>



<div class="post-comment" data-comment="utterances">
    <span class="post-comment-notloaded">
        <i class="iconfont icon-chatbox-ellipses-sharp"></i>&nbsp;查看评论
    </span>
    <script>
        function loadComment() {
            var commentArea = document.querySelector('.post-comment');
            var utterancesTheme = document.body.getAttribute('data-theme');
            if (utterancesTheme === 'auto') {
                utterancesTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'photon-dark' :
                    'github-light';
            } else {
                utterancesTheme = utterancesTheme === 'dark' ? 'photon-dark' : 'github-light';
            }
            var s = document.createElement('script');
            s.src = 'https://utteranc.es/client.js';
            s.setAttribute('repo', 'chenx6\/chenx6.github.io');
            s.setAttribute('issue-term', 'pathname');
            s.setAttribute('theme', utterancesTheme);
            s.setAttribute('crossorigin', 'anonymous');
            s.setAttribute('async', '');
            document.querySelector('.post-comment').appendChild(s);
            document.querySelector('span.post-comment-notloaded').setAttribute('style', 'display: none;');
        }
    </script>
</div>


            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/chenx6" target="_blank"><span>GitHub</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/arm/">arm</a>
            </span>
            
            <span>
                <a href="/tags/backdoor/">backdoor</a>
            </span>
            
            <span>
                <a href="/tags/c/">c</a>
            </span>
            
            <span>
                <a href="/tags/codeql/">codeql</a>
            </span>
            
            <span>
                <a href="/tags/compile/">compile</a>
            </span>
            
            <span>
                <a href="/tags/cpp/">cpp</a>
            </span>
            
            <span>
                <a href="/tags/elf/">elf</a>
            </span>
            
            <span>
                <a href="/tags/frida/">frida</a>
            </span>
            
            <span>
                <a href="/tags/fuzz/">fuzz</a>
            </span>
            
            <span>
                <a href="/tags/ida/">ida</a>
            </span>
            
            <span>
                <a href="/tags/linux/">linux</a>
            </span>
            
            <span>
                <a href="/tags/llvm/">llvm</a>
            </span>
            
            <span>
                <a href="/tags/mal/">mal</a>
            </span>
            
            <span>
                <a href="/tags/plt/">plt</a>
            </span>
            
            <span>
                <a href="/tags/pwn/">pwn</a>
            </span>
            
            <span>
                <a href="/tags/python/">python</a>
            </span>
            
            <span>
                <a href="/tags/re/">re</a>
            </span>
            
            <span>
                <a href="/tags/rop/">rop</a>
            </span>
            
            <span>
                <a href="/tags/rust/">rust</a>
            </span>
            
            <span>
                <a href="/tags/server/">server</a>
            </span>
            
            <span>
                <a href="/tags/vm/">vm</a>
            </span>
            
        </div>
    </div>
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#日志函数长什么样">日志函数长什么样</a></li>
    <li><a href="#在-ida-中上面的代码长什么样">在 IDA 中，上面的代码长什么样</a></li>
    <li><a href="#idapython-登场">IDAPython 登场</a></li>
    <li><a href="#refs">Refs</a></li>
  </ul>
</nav></div>
</aside>

        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>页面</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/search/">Search</a>
            </li>
            
            <li>
                <a href="/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>链接</h3>
        <ul>
            
            <li>
                <a href="https://github.com/chenx6" target="_blank"><span>GitHub</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>标签</h3>
        <div>
            
            <span>
                <a href="/tags/arm/">arm</a>
            </span>
            
            <span>
                <a href="/tags/backdoor/">backdoor</a>
            </span>
            
            <span>
                <a href="/tags/c/">c</a>
            </span>
            
            <span>
                <a href="/tags/codeql/">codeql</a>
            </span>
            
            <span>
                <a href="/tags/compile/">compile</a>
            </span>
            
            <span>
                <a href="/tags/cpp/">cpp</a>
            </span>
            
            <span>
                <a href="/tags/elf/">elf</a>
            </span>
            
            <span>
                <a href="/tags/frida/">frida</a>
            </span>
            
            <span>
                <a href="/tags/fuzz/">fuzz</a>
            </span>
            
            <span>
                <a href="/tags/ida/">ida</a>
            </span>
            
            <span>
                <a href="/tags/linux/">linux</a>
            </span>
            
            <span>
                <a href="/tags/llvm/">llvm</a>
            </span>
            
            <span>
                <a href="/tags/mal/">mal</a>
            </span>
            
            <span>
                <a href="/tags/plt/">plt</a>
            </span>
            
            <span>
                <a href="/tags/pwn/">pwn</a>
            </span>
            
            <span>
                <a href="/tags/python/">python</a>
            </span>
            
            <span>
                <a href="/tags/re/">re</a>
            </span>
            
            <span>
                <a href="/tags/rop/">rop</a>
            </span>
            
            <span>
                <a href="/tags/rust/">rust</a>
            </span>
            
            <span>
                <a href="/tags/server/">server</a>
            </span>
            
            <span>
                <a href="/tags/vm/">vm</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>目录</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#日志函数长什么样">日志函数长什么样</a></li>
    <li><a href="#在-ida-中上面的代码长什么样">在 IDA 中，上面的代码长什么样</a></li>
    <li><a href="#idapython-登场">IDAPython 登场</a></li>
    <li><a href="#refs">Refs</a></li>
  </ul>
</nav>
    </div>
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <p>
                除特殊注明部分，本站内容采用 <a rel="license" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a> 进行许可。
            </p>
            
            <span>&copy; 2022
                <a href="https://chenx6.github.io/">chen_null</a>
                
                | 基于 <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 构建
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>



</body>

</html>
