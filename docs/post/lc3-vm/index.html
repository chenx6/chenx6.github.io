<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>二进制咸鱼的自我救赎</title>
  <link rel="stylesheet" href="https://chenx6.github.io/water.min.css">
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
  <link rel="alternate" type="application/atom+xml" title="RSS" href="https://chenx6.github.io/atom.xml">
  

  
  

</head>

<body>
  <header>
    <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;"><h1>二进制咸鱼的自我救赎</h1></a>
    
    <p class="lead">幸福往往是摸的透彻，而敬业的心却常常隐藏。</p>
    
    
      <a href="https:&#x2F;&#x2F;chenx6.github.io&#x2F;&#x2F;about">
        About
      </a>
    
    
    <a href="https://chenx6.github.io/atom.xml">RSS</a>
    
  </header>
  
<div class="container">
  <aside class="toc">
    
    <ul>
      
      <li>
        <a href="https://chenx6.github.io/post/lc3-vm/#lc3-jia-gou">LC3 架构</a>
        
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#nei-cun">内存</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#zhi-ling">指令</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#ji-cun-qi">寄存器</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#qi-ta">其他</a>
          </li>
          
        </ul>
        
      </li>
      
      <li>
        <a href="https://chenx6.github.io/post/lc3-vm/#xu-ni-ji-shi-xian">虚拟机实现</a>
        
        <ul>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#xu-ni-ji-ji-ben-jia-gou">虚拟机基本架构</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#du-qu-cheng-xu">读取程序</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#zhi-xing-zhi-ling">执行指令</a>
          </li>
          
          <li>
            <a href="https://chenx6.github.io/post/lc3-vm/#trap-fan-yi">Trap 翻译</a>
          </li>
          
        </ul>
        
      </li>
      
      <li>
        <a href="https://chenx6.github.io/post/lc3-vm/#xu-ni-ji-ce-shi">虚拟机测试</a>
        
      </li>
      
      <li>
        <a href="https://chenx6.github.io/post/lc3-vm/#bian-yi">编译</a>
        
      </li>
      
      <li>
        <a href="https://chenx6.github.io/post/lc3-vm/#refs">refs</a>
        
      </li>
      
    </ul>
    
  </aside>
  <div class="post">
    <h2 class="post-title">LC3-VM 学习和实现</h1>
      <span class="post-date">2020-01-15</span>
      
  
    
      <a href="https://chenx6.github.io/tags/vm/">#vm</a>
    
  

      <p>本文是根据 <a href="https://justinmeiners.github.io/lc3-vm">https://justinmeiners.github.io/lc3-vm</a> 和 <a href="https://justinmeiners.github.io/lc3-vm/supplies/lc3-isa.pdf">https://justinmeiners.github.io/lc3-vm/supplies/lc3-isa.pdf</a> ISA 写出 LC3 VM 的实现过程。</p>
<p>代码已上传到了 Github 上：<a href="https://github.com/chenx6/lc3-vm">https://github.com/chenx6/lc3-vm</a></p>
<h2 id="lc3-jia-gou">LC3 架构</h2>
<h3 id="nei-cun">内存</h3>
<p>LC3 架构有 2^16 个地址，每个地址包含一个 word (2 byte, 16 bit)。是大端序存储。所以用 C 表示如下。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span>memory <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">UINT16_MAX <span class="z-keyword z-operator z-c">*</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h3 id="zhi-ling">指令</h3>
<p>指令长度为固定 16 bit (不定长的 x86 出来挨打)。12-15 bit 用于表示 opcode，其他部分则是根据 opcode 来发挥其用途。下面是使用枚举类型表示出 LC3 指令的 opcode。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-enum z-c"><span class="z-storage z-type z-c">enum</span> <span class="z-meta z-enum z-c"><span class="z-entity z-name z-enum z-c">Opcode</span></span></span><span class="z-meta z-enum z-c">
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c">
    OP_BR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> branch <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_ADD<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> add  <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_LD<span class="z-punctuation z-separator z-c">,</span>     <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> load <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_ST<span class="z-punctuation z-separator z-c">,</span>     <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> store <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_JSR<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> jump register <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_AND<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> bitwise and <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_LDR<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> load register <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_STR<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> store register <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_RTI<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> unused <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_NOT<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> bitwise not <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_LDI<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> load indirect <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_STI<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> store indirect <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_JMP<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> jump/ret <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_RES<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> reserved (unused) <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_LEA<span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> load effective address <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    OP_TRAP    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> execute trap <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h3 id="ji-cun-qi">寄存器</h3>
<p>LC3 有三种寄存器，通用寄存器 (R0-R7)，指令计数器 (PC)，条件寄存器 (COND)。</p>
<p>条件寄存器则是存储着三种状态：负数 (N)，零 (Z)，正 (P)。</p>
<p>下面是使用枚举类型表示出寄存器的下标，还有条件寄存器的条件。</p>
<blockquote>
<p>枚举类型的最后一个无实际价值，只是用来表示寄存器的数量</p>
</blockquote>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-enum z-c"><span class="z-storage z-type z-c">enum</span> <span class="z-meta z-enum z-c"><span class="z-entity z-name z-enum z-c">Register</span></span></span><span class="z-meta z-enum z-c">
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c">
    R_R0 <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> General purpose registers <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    R_R1<span class="z-punctuation z-separator z-c">,</span>
    R_R2<span class="z-punctuation z-separator z-c">,</span>
    R_R3<span class="z-punctuation z-separator z-c">,</span>
    R_R4<span class="z-punctuation z-separator z-c">,</span>
    R_R5<span class="z-punctuation z-separator z-c">,</span>
    R_R6<span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> User Stack Pointer <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    R_R7<span class="z-punctuation z-separator z-c">,</span>
    R_PC<span class="z-punctuation z-separator z-c">,</span>   <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Program counter <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    R_COND<span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Condition codes <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    R_COUNT <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Counter <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

<span class="z-meta z-enum z-c"><span class="z-storage z-type z-c">enum</span> <span class="z-meta z-enum z-c"><span class="z-entity z-name z-enum z-c">Condition</span></span></span><span class="z-meta z-enum z-c">
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c">
    FL_POS <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Positive <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    FL_ZRO <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Zero <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    FL_NEG <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Negative <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h3 id="qi-ta">其他</h3>
<p>LC3 还有中断，内存映射的 IO，优先级等。</p>
<p>在 LC3 中有个类似 x86 int 的 TRAP，实现输入输出等功能。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-enum z-c"><span class="z-storage z-type z-c">enum</span> <span class="z-meta z-enum z-c"><span class="z-entity z-name z-enum z-c">Trap</span></span></span><span class="z-meta z-enum z-c">
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c">
    TRAP_GETC <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>20</span><span class="z-punctuation z-separator z-c">,</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> get character from keyboard <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    TRAP_OUT <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>21</span><span class="z-punctuation z-separator z-c">,</span>   <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> output a character <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    TRAP_PUTS <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>22</span><span class="z-punctuation z-separator z-c">,</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> output a word string <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    TRAP_IN <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>23</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> input a string <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    TRAP_PUTSP <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>24</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> output a byte string <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    TRAP_HALT <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>25</span>   <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> halt the program <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<p>在内存中映射的寄存器，可以通过内存地址进行访问，这里可以访问内存知道当前键盘按下与否，按下的按键，还有输出状态的功能。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-enum z-c"><span class="z-storage z-type z-c">enum</span> <span class="z-meta z-enum z-c"><span class="z-entity z-name z-enum z-c">Memory</span></span></span><span class="z-meta z-enum z-c">
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c">
    MR_KBSR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FE00</span><span class="z-punctuation z-separator z-c">,</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> keyboard status <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    MR_KBDR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FE02</span><span class="z-punctuation z-separator z-c">,</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> keyboard data <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    MR_DSR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FE04</span><span class="z-punctuation z-separator z-c">,</span>   <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> display status <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    MV_DDR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FE06</span><span class="z-punctuation z-separator z-c">,</span>   <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> display data <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    MCR <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FFFE</span>       <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> machine control <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span><span class="z-meta z-enum z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h2 id="xu-ni-ji-shi-xian">虚拟机实现</h2>
<h3 id="xu-ni-ji-ji-ben-jia-gou">虚拟机基本架构</h3>
<p>原文将读取文件和解析指令耦合在了一起，并且将内存和寄存器都变成了全局变量，那样就不能同时跑多个虚拟机了。所以在我的实现中，将读取文件，和解析指令并执行进行了拆分，将存储内存和寄存器的数组从全局变量变成了动态内存，还从别的项目里偷了测试样例 <a href="https://github.com/viking/lc3-vm/">https://github.com/viking/lc3-vm/</a>，最后写个 CMake 来负责处理编译依赖。</p>
<p>通过一个结构体表示虚拟机的状态 (内存和寄存器) 会方便管理一些。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">typedef</span> <span class="z-storage z-type z-c">struct</span> _vm_ctx
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span>memory<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span>regs<span class="z-punctuation z-terminator z-c">;</span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span> <span class="z-entity z-name z-type z-typedef z-c">vm_ctx</span><span class="z-punctuation z-terminator z-c">;</span>

vm_ctx <span class="z-keyword z-operator z-c">*</span><span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">init_vm</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-modifier z-c">const</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">path</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    vm_ctx <span class="z-keyword z-operator z-c">*</span>curr_vm <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">vm_ctx</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>memory <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">read_image</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">path</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">*</span> R_COUNT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>

<span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">destory_vm</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c">vm_ctx <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">curr_vm</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>memory</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>整个虚拟机先从参数指向的程序读取程序镜像，然后开始不断运行程序，直到虚拟机解析到相关 Trap 时终止程序运行。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">argc</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">argv</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    vm_ctx <span class="z-keyword z-operator z-c">*</span>curr_vm<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>argc <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        curr_vm <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">init_vm</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">argv<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-c">else</span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">fprintf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">stderr<span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Usage: <span class="z-constant z-other z-placeholder z-c">%s</span> [program]<span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> argv<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">exit</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-arithmetic z-c">-</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>

    <span class="z-storage z-type z-c">int</span> running <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-c">while</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>running<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        running <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">execute_inst</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">destory_vm</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<h3 id="du-qu-cheng-xu">读取程序</h3>
<p>就是上面代码中出现的 <code>read_image</code> 函数。</p>
<p>由于程序为大端序，而平时使用的 x86 PC 是小端序，所以在读取时需要将程序转换成小端序以方便后面的解析。</p>
<p>我们通过 <code>read_image</code> 函数来将程序加载到内存中，并且转换为小端序的操作。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> change endianness <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">swap16</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-variable z-parameter z-c">x</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>x <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">8</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>x <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">8</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>

<span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">read_image</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-modifier z-c">const</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">path</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    FILE <span class="z-keyword z-operator z-c">*</span>file <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">fopen</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">path<span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>rb<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>file<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>[-] Read error!<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span>memory <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">INT16_MAX <span class="z-keyword z-operator z-c">*</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> the origin tells us where in memory to place the image <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> origin<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">fread</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>origin<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">origin</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> file</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    origin <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">swap16</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">origin</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> we know the maximum file size so we only need one fread <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> max_read <span class="z-keyword z-operator z-assignment z-c">=</span> UINT16_MAX <span class="z-keyword z-operator z-arithmetic z-c">-</span> origin<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span>p <span class="z-keyword z-operator z-assignment z-c">=</span> memory <span class="z-keyword z-operator z-arithmetic z-c">+</span> origin<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-sys-types z-c">size_t</span> read <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">fread</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">p<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-separator z-c">,</span> max_read<span class="z-punctuation z-separator z-c">,</span> file</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> swap file content to little endian <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    <span class="z-keyword z-control z-c">while</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>read<span class="z-keyword z-operator z-arithmetic z-c">--</span> <span class="z-keyword z-operator z-comparison z-c">&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-keyword z-operator z-c">*</span>p <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">swap16</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">*</span>p</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-keyword z-operator z-arithmetic z-c">++</span>p<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">fclose</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">file</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> memory<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<h3 id="zhi-xing-zhi-ling">执行指令</h3>
<p>执行指令前得解析指令格式，我们可以从前面的链接中拿到 ISA，根据上面的格式来进行解析。</p>
<h4 id="add">ADD</h4>
<p>例如 ADD 指令编码如下</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">15</span></span><span class="z-meta z-function-call z-arguments z-shell"> 14 13 12 11 10  9  8  7  6  5  4  3  2  1  0</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+--------------------+--------+--------+--------+</span></span>
<span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">DR</span></span>   <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SR1</span></span>   <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00</span></span>  <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SR2</span></span>   <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+--------------------------------------+--------+</span></span>
<span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">DR</span></span>   <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SR1</span></span>   <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1</span></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">imm5</span></span>      <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+--------------------+--------+-----------------+</span></span>
</span></code></pre>
<p>汇编格式</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c">ADD DR<span class="z-punctuation z-separator z-c">,</span> SR1<span class="z-punctuation z-separator z-c">,</span> SR2
ADD DR<span class="z-punctuation z-separator z-c">,</span> SR1<span class="z-punctuation z-separator z-c">,</span> imm5
</span></code></pre>
<p>描述</p>
<blockquote>
<p>If bit [5] is 0, the second source operand is obtained from SR2. If bit [5] is 1, the second source operand is obtained by sign-extending the imm5 ﬁeld to 16 bits. In both cases, the second source operand is added to the contents of SR1 and the result stored in DR. The condition codes are set, based on whether the result is negative, zero, or positive.</p>
</blockquote>
<p>通过上面的资料可以知道 ADD 指令的编码的 12-15 bit 为 ADD 的 opcode 0001，9-11 bit 为目标寄存器 8-6 bit 为源寄存器 1。由指令的 <code>bit [5]</code> 第 5 个 bit 指定操作对象，一种操作对象为立即数，另一种操作对象是寄存器。</p>
<p>所以根据分析写出如下代码，通过位操作取出目标寄存器和源寄存器的下标，或者取出立即数，通过下标访问不同寄存器进行计算。最后根据运算结果更新条件寄存器。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-keyword z-control z-c">switch</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>op<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
<span class="z-keyword z-control z-c">case</span> OP_ADD<span class="z-punctuation z-separator z-c">:</span>
    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> using {} to declare varible in labels <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-support z-type z-stdint z-c">uint16_t</span> dr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-support z-type z-stdint z-c">uint16_t</span> sr1 <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-support z-type z-stdint z-c">uint16_t</span> is_imm <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">5</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-terminator z-c">;</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> check the op2 is sr2 or imm <span class="z-punctuation z-definition z-comment z-c">*/</span></span>

        <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>is_imm<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            <span class="z-support z-type z-stdint z-c">uint16_t</span> imm5 <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">sign_extend</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">instr <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1F</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">5</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
            curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>dr<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>sr1<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">+</span> imm5<span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
        <span class="z-keyword z-control z-c">else</span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            <span class="z-support z-type z-stdint z-c">uint16_t</span> sr2 <span class="z-keyword z-operator z-assignment z-c">=</span> instr <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-terminator z-c">;</span>
            curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>dr<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>sr1<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">+</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>sr2<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">update_flags</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">dr<span class="z-punctuation z-separator z-c">,</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-flow z-break z-c">break</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> ... <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<p>取出立即数时需要注意立即数的长度为 5 bit，但是寄存器的长度为 16 bit。例如在长度为 4 bit 内使用补码表示 -1，则 0-3 bit 存储着 <code>1111</code>，直接转换为长度到 16 bit 时则和 31 <code>0000000000001111</code> 相等，造成混乱。这就需要对立即数进行扩展。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> convert to 16 bit with sign <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">sign_extend</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-variable z-parameter z-c">num</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">bit_count</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>num <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>bit_count <span class="z-keyword z-operator z-arithmetic z-c">-</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        num <span class="z-keyword z-operator z-assignment z-augmented z-c">|=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0X</span>FFFF</span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> bit_count<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> num<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>在进行完运算后，要根据结果将条件寄存器进行更新，这就是 <code>update_flags</code> 函数。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> using regs[index] to update flags <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">update_flags</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-variable z-parameter z-c">index</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-variable z-parameter z-c">regs</span><span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>index<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> FL_ZRO<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-c">else</span> <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>index<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">15</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> FL_NEG<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-c">else</span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> FL_POS<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<h4 id="ld">LD</h4>
<p>同样我们可以解析并执行 LD 语句的 C 语言代码。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"> 15 <span class="z-constant z-numeric z-integer z-decimal z-c">14</span> <span class="z-constant z-numeric z-integer z-decimal z-c">13</span> <span class="z-constant z-numeric z-integer z-decimal z-c">12</span> <span class="z-constant z-numeric z-integer z-decimal z-c">11</span> <span class="z-constant z-numeric z-integer z-decimal z-c">10</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">9</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">8</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">7</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">6</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">5</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">4</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">3</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">2</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">1</span>  <span class="z-constant z-numeric z-integer z-decimal z-c">0</span>
<span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">+</span>
<span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-keyword z-operator z-arithmetic z-c">|</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-keyword z-operator z-arithmetic z-c">|</span>   DR   <span class="z-keyword z-operator z-arithmetic z-c">|</span>        PCoffset9         <span class="z-keyword z-operator z-arithmetic z-c">|</span>
<span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">--</span><span class="z-keyword z-operator z-arithmetic z-c">+</span>
</span></code></pre>
<p>LD 语句就是从 PC + 相对偏移得到地址后，从地址中取出值并赋予 DR。当然 pc_offset 又是需要进行扩展的。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-keyword z-control z-c">case</span> OP_LD<span class="z-punctuation z-separator z-c">:</span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> dr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> pc_offset <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">sign_extend</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">instr <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1ff</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>dr<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">mem_read</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_PC<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-arithmetic z-c">+</span> pc_offset<span class="z-punctuation z-separator z-c">,</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>memory</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">update_flags</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">dr<span class="z-punctuation z-separator z-c">,</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<h4 id="br">BR</h4>
<p>而 BR 语句则是负责条件跳转，条件则为指令中的 9-11 bit 进行决定。例如指令中 N 位为 1，而且寄存器中的条件寄存器 N 也为 1，则跳转。N, P, Z 这三种条件可以自由组合，只要满足某一个条件就跳转。跳转表示为 PC 指针加上偏移值。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-keyword z-control z-c">case</span> OP_BR<span class="z-punctuation z-separator z-c">:</span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> n_flag <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">11</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> z_flag <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">10</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> p_flag <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> pc_offset <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">sign_extend</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">instr <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>1FF</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>n_flag <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-c">&amp;</span> FL_NEG<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">||</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>z_flag <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-c">&amp;</span> FL_ZRO<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">||</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>p_flag <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-c">&amp;</span> FL_POS<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>

        curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_PC<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-c">+=</span> pc_offset<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></code></pre>
<h4 id="mem-read-han-shu">mem_read 函数</h4>
<p>由于有内存映射的寄存器的存在，所以要将访问某些特殊地址时实际上是想访问某些寄存器，所以在读写特殊内存地址时要进行魔改。例如在访问 MR_KBSR 地址时候就需要将按键状态返回。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">mem_read</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-variable z-parameter z-c">address</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">memory</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> reading the memory mapped keyboard register triggers a key check <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>address <span class="z-keyword z-operator z-comparison z-c">==</span> MR_KBSR<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">check_key</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            memory<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>MR_KBSR<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">15</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
            memory<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>MR_KBDR<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">getchar</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
        <span class="z-keyword z-control z-c">else</span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            memory<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>MR_KBSR<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> memory<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>address<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p><code>check_key</code> 函数用于将按键状态返回给程序。首先将 STDIN 绑定到集合中，然后通过 <code>select</code> 函数监视文件描述符的状态，如果有按键输入，则返回 1，否则返回 0；</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> get keyboard status <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">check_key</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    fd_set readfds<span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">FD_ZERO</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>readfds</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">FD_SET</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">STDIN_FILENO<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>readfds</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-storage z-type z-c">struct</span> timeval timeout<span class="z-punctuation z-terminator z-c">;</span>
    timeout<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">tv_sec</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
    timeout<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">tv_usec</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">select</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>readfds<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>timeout</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<h4 id="trap">TRAP</h4>
<p>在处理中断时使用函数来进行处理，降低代码耦合度。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-keyword z-control z-c">case</span> OP_TRAP<span class="z-punctuation z-separator z-c">:</span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
    running <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">execute_trap</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-separator z-c">,</span> instr<span class="z-punctuation z-separator z-c">,</span> stdin<span class="z-punctuation z-separator z-c">,</span> stdout</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
<span class="z-keyword z-control z-flow z-break z-c">break</span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h3 id="trap-fan-yi">Trap 翻译</h3>
<p>将不同中断用 C 语言表示就行。由 ISA 可以知道 Trap 向量由 0-7 bit 表示。上面已经提及过了 Trap 的路径和功能，所以相关功能使用 C 语言表示如下。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-keyword z-control z-c">switch</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>instr <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>FF</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
<span class="z-keyword z-control z-c">case</span> TRAP_GETC<span class="z-punctuation z-separator z-c">:</span>
<span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> c <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">getc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">in</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_R0<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> c<span class="z-punctuation z-terminator z-c">;</span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
<span class="z-keyword z-control z-flow z-break z-c">break</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> ... <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
<span class="z-keyword z-control z-flow z-break z-c">break</span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<h2 id="xu-ni-ji-ce-shi">虚拟机测试</h2>
<p>通过位运算构造相应的指令，然后运行此指令，看看预期和结果是否相符。如果不相符就是挂了，返回 0；如果通过了那就返回 1。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">test_add_1</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c">vm_ctx <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">curr_vm</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    <span class="z-storage z-type z-c">int</span> pass <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-support z-type z-stdint z-c">uint16_t</span> add_instr <span class="z-keyword z-operator z-assignment z-c">=</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>OP_ADD <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>f</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">12</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>R_R0 <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">9</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>R_R1 <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&lt;&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">|</span>
        <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>R_R2 <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>7</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>

    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>memory<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>3000</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> add_instr<span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_R1<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_R2<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-storage z-type z-c">int</span> result <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">execute_inst</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>result <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Expected return value to be 1, got <span class="z-constant z-other z-placeholder z-c">%d</span><span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> result</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        pass <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>

    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_R0<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">3</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Expected register 0 to contain 3, got <span class="z-constant z-other z-placeholder z-c">%d</span><span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_R0<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        pass <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>

    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> FL_POS<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Expected condition flags to be <span class="z-constant z-other z-placeholder z-c">%d</span>, got <span class="z-constant z-other z-placeholder z-c">%d</span><span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> FL_POS<span class="z-punctuation z-separator z-c">,</span> curr_vm<span class="z-punctuation z-accessor z-c">-&gt;</span>regs<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_COND<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        pass <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>

    <span class="z-keyword z-control z-flow z-return z-c">return</span> pass<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>通过将不同测试函数用指针数组装起来，不断调用，通过返回值判断测试样例是否通过。</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">test_env</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
    vm_ctx curr_vm<span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">regs</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-c">*</span> R_COUNT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">memory</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">malloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">UINT16_MAX <span class="z-keyword z-operator z-c">*</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-storage z-type z-c">int</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-c">*</span>test_case<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>vm_ctx <span class="z-keyword z-operator z-c">*</span> curr_vm<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>test_add_1<span class="z-punctuation z-separator z-c">,</span> test_add_2<span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>

    <span class="z-storage z-type z-c">int</span> result <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-storage z-type z-c">int</span> case_num <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">test_case</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">/</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c"><span class="z-support z-type z-stdint z-c">uint16_t</span> <span class="z-keyword z-operator z-c">*</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-c">for</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">int</span> i <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span> i <span class="z-keyword z-operator z-comparison z-c">&lt;</span> case_num<span class="z-punctuation z-terminator z-c">;</span> i<span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
    <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
        curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">regs</span><span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>R_PC<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-c"><span class="z-punctuation z-definition z-numeric z-base z-c">0x</span>3000</span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">memset</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">memory</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> UINT16_MAX</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">memset</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">regs</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> R_COUNT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        result <span class="z-keyword z-operator z-assignment z-c">=</span> test_case<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>i<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-c">&amp;</span>curr_vm<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>result <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Test <span class="z-constant z-other z-placeholder z-c">%d</span> fail!<span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> i</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
            <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">memory</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
            <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">regs</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
            <span class="z-keyword z-control z-flow z-return z-c">return</span> result<span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>

        <span class="z-keyword z-control z-c">else</span> <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>result <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
        <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
            <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>Test <span class="z-constant z-other z-placeholder z-c">%d</span> passed!<span class="z-constant z-character z-escape z-c">\n</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> i</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">memory</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">curr_vm<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">regs</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
    <span class="z-keyword z-control z-flow z-return z-c">return</span> result<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>原文中还有编译好的 2048 和 rouge，可以试着跑一下。</p>
<h2 id="bian-yi">编译</h2>
<p>使用 CMake 进行依赖处理，将测试程序和源程序分开，并且使用 <code>make test</code> 就可以跑测试了。</p>
<pre data-lang="cmake" class="language-cmake z-code"><code class="language-cmake" data-lang="cmake"><span class="z-source z-cmake"><span class="z-meta z-function-call z-cmake"><span class="z-keyword z-control z-if z-cmake">if</span></span><span class="z-meta z-group z-if z-cmake"><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-variable z-parameter z-if z-POLICY z-cmake">POLICY</span> <span class="z-meta z-string z-unquoted z-cmake">CMP0048</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
  <span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-cmake_policy z-cmake">cmake_policy</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-variable z-parameter z-SET z-cmake">SET</span> <span class="z-meta z-string z-unquoted z-cmake">CMP0048</span> <span class="z-variable z-parameter z-NEW z-cmake">NEW</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span> <span class="z-comment z-line z-cmake"><span class="z-punctuation z-definition z-comment z-cmake">#</span> CMake 3.0</span>
<span class="z-meta z-function-call z-cmake"><span class="z-keyword z-control z-endif z-cmake">endif</span></span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>

<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-project z-cmake">project</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-string z-unquoted z-cmake">lc3-vm</span> <span class="z-variable z-parameter z-VERSION z-cmake">VERSION</span> <span class="z-meta z-string z-unquoted z-cmake">0.1</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-cmake_minimum_required z-cmake">cmake_minimum_required</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-variable z-parameter z-VERSION z-cmake">VERSION</span> <span class="z-meta z-string z-unquoted z-cmake">2.6</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-set z-cmake">set</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-variable z-other z-readwrite z-assignment z-cmake">CMAKE_C_STANDARD</span> <span class="z-meta z-string z-unquoted z-cmake">99</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_library z-cmake">add_library</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-string z-unquoted z-cmake">read_image</span> <span class="z-variable z-parameter z-OBJECT z-cmake">OBJECT</span> <span class="z-meta z-string z-unquoted z-cmake">lc3.h</span> <span class="z-meta z-string z-unquoted z-cmake">read_image.c</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_library z-cmake">add_library</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-string z-unquoted z-cmake">exec_inst</span> <span class="z-variable z-parameter z-OBJECT z-cmake">OBJECT</span> <span class="z-meta z-string z-unquoted z-cmake">lc3.h</span> <span class="z-meta z-string z-unquoted z-cmake">exec_inst.c</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_executable z-cmake">add_executable</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span> <span class="z-meta z-generator-expression z-cmake"><span class="z-punctuation z-definition z-variable z-generator-expression z-cmake">$</span><span class="z-punctuation z-section z-block z-begin z-cmake">&lt;</span><span class="z-variable z-other z-readwrite z-cmake">TARGET_OBJECTS</span><span class="z-punctuation z-separator z-generator-expression z-cmake">:</span></span><span class="z-meta z-generator-expression z-cmake"><span class="z-variable z-other z-readwrite z-cmake">read_image</span></span><span class="z-punctuation z-section z-block z-end z-cmake">&gt;</span> <span class="z-meta z-generator-expression z-cmake"><span class="z-punctuation z-definition z-variable z-generator-expression z-cmake">$</span><span class="z-punctuation z-section z-block z-begin z-cmake">&lt;</span><span class="z-variable z-other z-readwrite z-cmake">TARGET_OBJECTS</span><span class="z-punctuation z-separator z-generator-expression z-cmake">:</span></span><span class="z-meta z-generator-expression z-cmake"><span class="z-variable z-other z-readwrite z-cmake">exec_inst</span></span><span class="z-punctuation z-section z-block z-end z-cmake">&gt;</span> <span class="z-meta z-string z-unquoted z-cmake">main.c</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>

<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_executable z-cmake">add_executable</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-meta z-string z-unquoted z-cmake">-test</span> <span class="z-meta z-generator-expression z-cmake"><span class="z-punctuation z-definition z-variable z-generator-expression z-cmake">$</span><span class="z-punctuation z-section z-block z-begin z-cmake">&lt;</span><span class="z-variable z-other z-readwrite z-cmake">TARGET_OBJECTS</span><span class="z-punctuation z-separator z-generator-expression z-cmake">:</span></span><span class="z-meta z-generator-expression z-cmake"><span class="z-variable z-other z-readwrite z-cmake">read_image</span></span><span class="z-punctuation z-section z-block z-end z-cmake">&gt;</span> <span class="z-meta z-generator-expression z-cmake"><span class="z-punctuation z-definition z-variable z-generator-expression z-cmake">$</span><span class="z-punctuation z-section z-block z-begin z-cmake">&lt;</span><span class="z-variable z-other z-readwrite z-cmake">TARGET_OBJECTS</span><span class="z-punctuation z-separator z-generator-expression z-cmake">:</span></span><span class="z-meta z-generator-expression z-cmake"><span class="z-variable z-other z-readwrite z-cmake">exec_inst</span></span><span class="z-punctuation z-section z-block z-end z-cmake">&gt;</span> <span class="z-meta z-string z-unquoted z-cmake">test.c</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-enable_testing z-cmake">enable_testing</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-add_test z-cmake">add_test</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span><span class="z-variable z-parameter z-NAME z-cmake">NAME</span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-meta z-string z-unquoted z-cmake">-test</span> <span class="z-variable z-parameter z-COMMAND z-cmake">COMMAND</span> <span class="z-meta z-string z-unquoted z-cmake">./<span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span>-test</span> <span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
<span class="z-meta z-function-call z-cmake"><span class="z-support z-function z-set_tests_properties z-cmake">SET_TESTS_PROPERTIES</span></span><span class="z-meta z-function-call z-arguments z-cmake"><span class="z-punctuation z-section z-parens z-begin z-cmake">(</span> <span class="z-meta z-text-substitution z-cmake"><span class="z-punctuation z-definition z-variable z-substitution z-cmake">$</span><span class="z-punctuation z-section z-braces z-begin z-cmake">{</span><span class="z-variable z-other z-readwrite z-cmake">PROJECT_NAME</span><span class="z-punctuation z-section z-braces z-end z-cmake">}</span></span><span class="z-meta z-string z-unquoted z-cmake">-test</span> <span class="z-variable z-parameter z-PROPERTIES z-cmake">PROPERTIES</span>
  <span class="z-meta z-string z-unquoted z-cmake">PASS_REGULAR_EXPRESSION</span> <span class="z-string z-quoted z-double z-cmake"><span class="z-punctuation z-definition z-string z-begin z-cmake">&quot;</span>All test passed!<span class="z-punctuation z-definition z-string z-end z-cmake">&quot;</span></span>
  <span class="z-meta z-string z-unquoted z-cmake">FAIL_REGULAR_EXPRESSION</span> <span class="z-string z-quoted z-double z-cmake"><span class="z-punctuation z-definition z-string z-begin z-cmake">&quot;</span>Test [<span class="z-constant z-character z-escape z-cmake">\\</span>d]+ fail!<span class="z-punctuation z-definition z-string z-end z-cmake">&quot;</span></span>
<span class="z-punctuation z-section z-parens z-end z-cmake">)</span></span>
</span></code></pre>
<h2 id="refs">refs</h2>
<p>原文 <a href="https://justinmeiners.github.io/lc3-vm">https://justinmeiners.github.io/lc3-vm</a>
这个 C 实现的虚拟机封装比较完整 <a href="https://github.com/rpendleton/lc3sim-c">https://github.com/rpendleton/lc3sim-c</a>
这个实现里加了测试样例 <a href="https://github.com/viking/lc3-vm">https://github.com/viking/lc3-vm</a></p>

  </div>
</div>

</body>

</html>